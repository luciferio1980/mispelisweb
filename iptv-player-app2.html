<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamFlix IPTV Player</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        :root {
            --netflix-red: #E50914;
            --netflix-black: #141414;
            --netflix-dark: #000000;
            --netflix-gray: #2F2F2F;
            --netflix-light-gray: #808080;
            --sidebar-width: 280px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            scrollbar-width: thin;
            scrollbar-color: var(--netflix-red) var(--netflix-dark);
        }

        body {
            font-family: 'Netflix Sans', 'Helvetica Neue', Arial, sans-serif;
            background: var(--netflix-black);
            color: white;
            overflow-x: hidden;
        }

        /* DEVICE SELECTOR MODAL */
        .device-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.3s;
        }

        .device-modal.hidden {
            display: none;
        }

        .device-content {
            background: var(--netflix-gray);
            padding: 40px;
            border-radius: 15px;
            max-width: 600px;
            text-align: center;
        }

        .device-content h2 {
            font-size: 2em;
            margin-bottom: 30px;
            color: var(--netflix-red);
        }

        .device-options {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .device-option {
            background: var(--netflix-black);
            padding: 30px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            min-width: 150px;
        }

        .device-option:hover {
            border-color: var(--netflix-red);
            transform: scale(1.05);
        }

        .device-option .icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        /* SIDEBAR */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--netflix-dark);
            border-right: 2px solid var(--netflix-gray);
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .sidebar.mobile-hidden {
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: 20px;
            background: var(--netflix-red);
            text-align: center;
        }

        .sidebar-header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-item:hover, .menu-item.active {
            background: var(--netflix-gray);
            border-left-color: var(--netflix-red);
        }

        .menu-icon {
            font-size: 1.3em;
        }

        .categories-list {
            max-height: 0;
            overflow-y: auto;
            overflow-x: hidden;
            transition: max-height 0.3s ease;
            background: rgba(0,0,0,0.3);
        }

        .categories-list.expanded {
            max-height: 50vh;
        }

        .category-item {
            padding: 12px 20px 12px 50px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95em;
            display: flex;
            justify-content: space-between;
        }

        .category-item:hover {
            background: var(--netflix-gray);
            padding-left: 55px;
        }

        .category-item .count {
            background: var(--netflix-red);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.85em;
        }

        /* HAMBURGER MENU */
        .hamburger {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: var(--netflix-red);
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.5em;
            color: white;
        }

        /* MAIN CONTENT */
        .main-content {
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            padding: 30px;
            transition: margin-left 0.3s ease;
        }

        .main-content.full-width {
            margin-left: 0;
            padding-left: 80px;
        }

        /* TOP BAR */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .search-container {
            flex: 1;
            max-width: 500px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            background: var(--netflix-gray);
            border: 2px solid transparent;
            border-radius: 5px;
            color: white;
            font-size: 16px;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--netflix-red);
            background: var(--netflix-black);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2em;
            color: var(--netflix-light-gray);
        }

        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--netflix-gray);
            border-radius: 5px;
            margin-top: 5px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 100;
        }

        .search-suggestions.active {
            display: block;
        }

        .suggestion-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s;
        }

        .suggestion-item:hover {
            background: var(--netflix-black);
            padding-left: 20px;
        }

        /* ACTION BUTTONS */
        .top-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            background: var(--netflix-red);
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn:hover {
            background: #f40612;
            transform: scale(1.05);
        }

        .btn-secondary {
            background: var(--netflix-gray);
        }

        .btn-secondary:hover {
            background: var(--netflix-light-gray);
        }

        /* VIEW MODES */
        .view-modes {
            display: flex;
            gap: 10px;
            background: var(--netflix-gray);
            padding: 5px;
            border-radius: 5px;
        }

        .view-mode {
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.3s;
        }

        .view-mode.active {
            background: var(--netflix-red);
        }

        /* CONTENT SECTIONS */
        .content-section {
            display: none;
            animation: fadeIn 0.5s;
        }

        .content-section.active {
            display: block;
        }

        /* UPLOAD SECTION */
        .upload-container {
            background: var(--netflix-gray);
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .upload-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .upload-tab {
            padding: 10px 20px;
            background: var(--netflix-black);
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-tab.active {
            background: var(--netflix-red);
        }

        .upload-content {
            display: none;
        }

        .upload-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--netflix-light-gray);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            background: var(--netflix-black);
            border: 2px solid var(--netflix-gray);
            border-radius: 5px;
            color: white;
            font-size: 14px;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--netflix-red);
        }

        /* CHANNELS GRID */
        .channels-container {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .channels-container.grid-view {
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        }

        .channels-container.list-view {
            grid-template-columns: 1fr;
        }

        .channel-card {
            background: var(--netflix-gray);
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            border: 1px solid transparent;
        }

        .channel-card:hover {
            transform: scale(1.05);
            border-color: var(--netflix-red);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .channel-card.list-view {
            display: flex;
            align-items: center;
            padding: 15px;
        }

        .channel-logo {
            width: 100%;
            height: 120px;
            object-fit: contain;
            background: var(--netflix-black);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            overflow: hidden;
        }

        .channel-logo img {
            max-width: 100%;
            max-height: 100%;
        }

        .channel-card.list-view .channel-logo {
            width: 80px;
            height: 80px;
            border-radius: 5px;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .channel-info {
            padding: 15px;
        }

        .channel-card.list-view .channel-info {
            flex: 1;
            padding: 0;
        }

        .channel-name {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 1em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .channel-category {
            color: var(--netflix-light-gray);
            font-size: 0.8em;
            margin-bottom: 5px;
        }

        .channel-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            justify-content: space-between;
        }

        .channel-card.list-view .channel-actions {
            margin-left: auto;
        }

        .action-btn {
            padding: 5px 10px;
            background: var(--netflix-red);
            border: none;
            border-radius: 3px;
            color: white;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s;
        }

        .action-btn:hover {
            background: #f40612;
        }

        .action-btn.favorite {
            background: transparent;
            border: 1px solid var(--netflix-red);
        }

        .action-btn.favorite.active {
            background: var(--netflix-red);
        }

        /* PAGINATION */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .page-btn {
            padding: 8px 12px;
            background: var(--netflix-gray);
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .page-btn:hover, .page-btn.active {
            background: var(--netflix-red);
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--netflix-gray);
        }

        /* LOADING */
        .loading-container {
            display: none;
            text-align: center;
            padding: 60px;
        }

        .loading-container.active {
            display: block;
        }

        .loading-spinner {
            border: 4px solid rgba(255,255,255,0.1);
            border-top: 4px solid var(--netflix-red);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        /* ANIMATIONS */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* MOBILE RESPONSIVE */
        @media (max-width: 768px) {
            :root {
                --sidebar-width: 250px;
            }
            .hamburger { display: block; }
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 80px 15px 15px 15px; }
            .top-bar { flex-direction: column; align-items: stretch; }
            .search-container { max-width: 100%; }
        }

        /* FILTERS */
        .filters-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 150px;
        }

        .filter-group select {
            width: 100%;
            padding: 10px;
            background: var(--netflix-gray);
            border: 2px solid var(--netflix-gray);
            border-radius: 5px;
            color: white;
            cursor: pointer;
        }

        /* LISTS MANAGER */
        .lists-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .list-card {
            background: var(--netflix-gray);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid transparent;
            position: relative;
        }

        .list-card.active {
            border-color: var(--netflix-red);
            background: rgba(229, 9, 20, 0.1);
        }

        .list-stats {
            display: flex;
            justify-content: space-between;
            color: var(--netflix-light-gray);
            font-size: 0.9em;
            margin-top: 10px;
        }

        .list-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .list-actions button {
            flex: 1;
            padding: 8px;
            font-size: 0.9em;
        }

        .recording-path input { flex: 1; }
        .recording-path { display: flex; gap: 10px; align-items: center; }
        .path-display { background: var(--netflix-black); padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 0.9em; color: var(--netflix-light-gray); }
        
        /* PARENTAL */
        .category-toggle { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--netflix-black); margin-bottom: 10px; border-radius: 5px; }
        .toggle-switch { width: 50px; height: 24px; background: #ccc; border-radius: 12px; position: relative; cursor: pointer; transition: all 0.3s; }
        .toggle-switch.active { background: var(--netflix-red); }
        .toggle-switch::after { content: ''; position: absolute; width: 20px; height: 20px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: all 0.3s; }
        .toggle-switch.active::after { left: 28px; }
    </style>
</head>
<body>
    
    <div class="device-modal" id="deviceModal">
        <div class="device-content">
            <h2>üé¨ Bienvenido a StreamFlix</h2>
            <p style="margin-bottom: 30px; color: var(--netflix-light-gray);">
                Selecciona tu dispositivo para optimizar la experiencia
            </p>
            <div class="device-options">
                <div class="device-option" onclick="selectDevice('pc')">
                    <div class="icon">üíª</div>
                    <div>PC / Laptop</div>
                </div>
                <div class="device-option" onclick="selectDevice('mobile')">
                    <div class="icon">üì±</div>
                    <div>M√≥vil / Tablet</div>
                </div>
                <div class="device-option" onclick="selectDevice('tv')">
                    <div class="icon">üì∫</div>
                    <div>Smart TV</div>
                </div>
            </div>
        </div>
    </div>

    <button class="hamburger" onclick="toggleSidebar()">‚ò∞</button>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1>üé¨ StreamFlix</h1>
            <p>Tu IPTV Premium</p>
        </div>

        <div class="sidebar-menu">
            <div class="menu-item active" onclick="showSection('home')">
                <span class="menu-icon">üè†</span>
                <span>Inicio</span>
            </div>

            <div class="menu-item" onclick="toggleCategories()">
                <span class="menu-icon">üìÅ</span>
                <span>Categor√≠as</span>
                <span style="margin-left: auto;">‚ñº</span>
            </div>
            <div class="categories-list" id="categoriesList"></div>

            <div class="menu-item" onclick="showSection('favorites')">
                <span class="menu-icon">‚≠ê</span>
                <span>Favoritos</span>
                <span class="count" id="favCount" style="margin-left: auto; background: var(--netflix-red); padding: 2px 8px; border-radius: 10px; font-size: 0.85em;">0</span>
            </div>

            <div class="menu-item" onclick="showSection('lists')">
                <span class="menu-icon">üìã</span>
                <span>Mis Listas</span>
            </div>

            <div class="menu-item" onclick="showSection('settings')">
                <span class="menu-icon">‚öôÔ∏è</span>
                <span>Configuraci√≥n</span>
            </div>
            
            <div class="menu-item" onclick="showSection('parental')">
                <span class="menu-icon">üîí</span>
                <span>Control Parental</span>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="top-bar">
            <div class="search-container">
                <input type="text" class="search-input" id="searchInput" placeholder="Buscar canales..." oninput="handleSearch()">
                <span class="search-icon">üîç</span>
                <div class="search-suggestions" id="searchSuggestions"></div>
            </div>

            <div class="top-actions">
                <div class="view-modes">
                    <div class="view-mode active" onclick="setViewMode('grid')" title="Vista Grid">‚äû</div>
                    <div class="view-mode" onclick="setViewMode('list')" title="Vista Lista">‚ò∞</div>
                </div>
                <button class="btn btn-secondary" onclick="showSection('upload')">‚ûï A√±adir Lista</button>
            </div>
        </div>

        <div class="loading-container" id="loadingContainer">
            <div class="loading-spinner"></div>
            <p id="loadingText">Cargando contenido...</p>
        </div>

        <div class="content-section active" id="homeSection">
            <h2 style="margin-bottom: 20px;">üì∫ Todos los Canales</h2>
            
            <div class="filters-container">
                <div class="filter-group">
                    <select id="categoryFilter" onchange="applyFilters()">
                        <option value="">Todas las categor√≠as</option>
                    </select>
                </div>
                <div class="filter-group">
                    <select id="countryFilter" onchange="applyFilters()">
                        <option value="">Todos los pa√≠ses</option>
                    </select>
                </div>
            </div>

            <div class="channels-container grid-view" id="channelsContainer"></div>
            <div class="pagination" id="pagination"></div>
        </div>

        <div class="content-section" id="uploadSection">
            <h2 style="margin-bottom: 20px;">‚ûï A√±adir Nueva Lista</h2>
            
            <div class="upload-container">
                <div class="upload-tabs">
                    <button class="upload-tab active" onclick="switchUploadTab(event, 'm3u')">üìÑ M3U/M3U8</button>
                    <button class="upload-tab" onclick="switchUploadTab(event, 'xtream')">üîå Xtream Codes</button>
                </div>

                <p id="uploadStatusMessage" style="color: #E50914; margin-bottom: 15px; font-weight: bold; min-height: 20px;"></p>

                <div class="upload-content active" id="m3uUpload">
                    <div class="form-group">
                        <label>Nombre de la lista:</label>
                        <input type="text" id="listName" placeholder="Mi lista IPTV">
                    </div>

                    <div class="form-group">
                        <label>üìÅ Subir archivo local (.m3u):</label>
                        <input type="file" id="fileInput" accept=".m3u,.m3u8,.txt">
                    </div>

                    <div class="form-group">
                        <label>üîó O introduce URL (con soporte CORS):</label>
                        <input type="url" id="urlInput" placeholder="https://ejemplo.com/lista.m3u8">
                    </div>

                    <button class="btn" onclick="loadM3U()">Cargar Lista M3U</button>
                </div>

                <div class="upload-content" id="xtreamUpload">
                    <div class="form-group">
                        <label>Nombre de la lista:</label>
                        <input type="text" id="xtreamListName" placeholder="Mi Xtream">
                    </div>
                    <div class="form-group">
                        <label>Servidor (http://url:port):</label>
                        <input type="text" id="xtreamServer" placeholder="http://servidor.com:8080">
                    </div>
                    <div class="form-group">
                        <label>Usuario:</label>
                        <input type="text" id="xtreamUser" placeholder="usuario">
                    </div>
                    <div class="form-group">
                        <label>Contrase√±a:</label>
                        <input type="password" id="xtreamPass" placeholder="contrase√±a">
                    </div>
                    <button class="btn" onclick="loadXtream()">Conectar Xtream</button>
                </div>
            </div>
        </div>

        <div class="content-section" id="favoritesSection">
            <h2 style="margin-bottom: 20px;">‚≠ê Mis Favoritos</h2>
            <div class="channels-container grid-view" id="favoritesContainer"></div>
        </div>

        <div class="content-section" id="listsSection">
            <h2 style="margin-bottom: 20px;">üìã Gesti√≥n de Listas</h2>
            <div class="lists-container" id="listsContainer"></div>
        </div>

        <div class="content-section" id="settingsSection">
            <h2 style="margin-bottom: 20px;">‚öôÔ∏è Configuraci√≥n</h2>
            
            <div class="upload-container">
                <h3 style="margin-bottom: 20px;">üé¨ Carpeta de "Grabaci√≥n"</h3>
                <p style="color: #aaa; font-size: 0.9em; margin-bottom: 10px;">Nota: Los navegadores web no permiten guardar directamente en rutas del disco duro (como C:\) por seguridad. Las grabaciones se descargar√°n como archivos en tu carpeta de descargas.</p>
                
                <div class="form-group">
                    <div class="recording-path">
                        <button class="btn btn-secondary" onclick="saveRecordingPath()">Restablecer Ubicaci√≥n</button>
                    </div>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 20px;">üì± Dispositivo</h3>
                <div class="form-group">
                    <button class="btn btn-secondary" onclick="changeDevice()">Cambiar Tipo de Dispositivo</button>
                    <div class="path-display" id="deviceDisplay" style="margin-top: 10px;"></div>
                </div>
            </div>
        </div>

        <div class="content-section" id="parentalSection">
            <h2 style="margin-bottom: 20px;">üîí Control Parental</h2>
            <div class="upload-container" id="parentalContainer">
                <p style="margin-bottom: 15px; color: #aaa;">Oculta categor√≠as completas de la lista de canales.</p>
                <div id="parentalCategories"></div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let allChannels = [];
        let currentChannels = [];
        let categories = {};
        let favorites = new Set();
        let savedLists = [];
        let currentList = null;
        let currentPage = 1;
        let itemsPerPage = 24; // Por defecto PC
        let currentViewMode = 'grid';
        let deviceType = localStorage.getItem('streamflix_device') || 'pc';
        let blockedCategories = new Set();
        
        const STORAGE = {
            DEVICE: 'streamflix_device',
            FAVORITES: 'streamflix_favorites',
            LISTS: 'streamflix_lists',
            CURRENT_LIST: 'streamflix_current_list',
            BLOCKED_CATS: 'streamflix_blocked'
        };

        // ==========================================
        // INIT
        // ==========================================
        window.onload = function() {
            loadFromStorage();
            checkDevice();
        };

        // ==========================================
        // DEVICE & UI
        // ==========================================
        function selectDevice(type) {
            localStorage.setItem(STORAGE.DEVICE, type);
            document.getElementById('deviceModal').classList.add('hidden');
            deviceType = type;
            applyDeviceSettings(type);
        }

        function applyDeviceSettings(type) {
            if (type === 'tv') {
                itemsPerPage = 12;
            } else if (type === 'mobile') {
                itemsPerPage = 10;
            } else {
                itemsPerPage = 24;
            }
            updateDeviceDisplay(type);
            if(currentChannels.length > 0) displayChannels();
        }

        function updateDeviceDisplay(type) {
            const names = { pc: 'üíª PC', mobile: 'üì± M√≥vil', tv: 'üì∫ TV' };
            const disp = document.getElementById('deviceDisplay');
            if(disp) disp.textContent = `Modo actual: ${names[type] || type}`;
        }

        function changeDevice() {
            localStorage.removeItem(STORAGE.DEVICE);
            location.reload();
        }

        function checkDevice() {
            const saved = localStorage.getItem(STORAGE.DEVICE);
            if (!saved) {
                document.getElementById('deviceModal').classList.remove('hidden');
            } else {
                document.getElementById('deviceModal').classList.add('hidden');
                applyDeviceSettings(saved);
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            
            // Activar secci√≥n
            const target = document.getElementById(sectionId + 'Section');
            if (target) target.classList.add('active');
            
            // Activar men√∫
            const menuItem = Array.from(document.querySelectorAll('.menu-item')).find(i => i.getAttribute('onclick')?.includes(sectionId));
            if(menuItem) menuItem.classList.add('active');

            // L√≥gica espec√≠fica
            if(sectionId === 'favorites') displayFavorites();
            if(sectionId === 'lists') displayLists();
            if(sectionId === 'parental') displayParentalControls();
            if(sectionId === 'home' && currentChannels.length === 0 && allChannels.length > 0) {
                applyFilters(); // Restaurar vista
            }

            // M√≥vil: cerrar men√∫ al navegar
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('active');
            }
        }

        function showLoading(show, text) {
            const el = document.getElementById('loadingContainer');
            const txt = document.getElementById('loadingText');
            if(show) {
                el.classList.add('active');
                if(text) txt.textContent = text;
            } else {
                el.classList.remove('active');
            }
        }

        function updateStatus(msg) {
            const el = document.getElementById('uploadStatusMessage');
            if(el) el.textContent = msg;
        }

        function switchUploadTab(e, tab) {
            if(e) e.preventDefault();
            document.querySelectorAll('.upload-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.upload-content').forEach(c => c.classList.remove('active'));
            
            // Activar bot√≥n
            if (e && e.target) {
               e.target.classList.add('active');
            } else {
                // Fallback si se llama program√°ticamente
                const btn = document.querySelector(`.upload-tab[onclick*="${tab}"]`);
                if(btn) btn.classList.add('active');
            }
            
            document.getElementById(tab + 'Upload').classList.add('active');
            updateStatus('');
        }

        // ==========================================
        // LOGICA DE CARGA M3U & XTREAM
        // ==========================================
        
        async function loadM3U() {
            const fileInput = document.getElementById('fileInput');
            const urlInput = document.getElementById('urlInput').value;
            const listName = document.getElementById('listName').value || 'Lista M3U';

            if (!fileInput.files.length && !urlInput) {
                alert('Selecciona un archivo o introduce una URL');
                return;
            }

            showLoading(true, 'Procesando lista...');
            updateStatus('Cargando...');

            try {
                let content = '';
                if (fileInput.files.length > 0) {
                    content = await fileInput.files[0].text();
                } else {
                    // Usamos un CORS Proxy p√∫blico para evitar bloqueos
                    updateStatus('Descargando v√≠a CORS Proxy...');
                    const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(urlInput);
                    const resp = await fetch(proxyUrl);
                    if(!resp.ok) throw new Error('Error al descargar la URL');
                    content = await resp.text();
                }

                const channels = parseM3U(content);
                if (channels.length === 0) throw new Error('No se encontraron canales v√°lidos');

                const newList = {
                    id: Date.now(),
                    name: listName,
                    channels: channels,
                    type: 'm3u',
                    date: new Date().toISOString()
                };

                savedLists.push(newList);
                saveToStorage();
                loadList(newList);
                
                updateStatus(`‚úÖ Cargados ${channels.length} canales.`);
                showSection('home');

            } catch (e) {
                console.error(e);
                updateStatus('‚ùå Error: ' + e.message);
                alert('Error: ' + e.message);
            } finally {
                showLoading(false);
            }
        }

        function parseM3U(content) {
            const lines = content.split('\n');
            const channels = [];
            let current = null;

            lines.forEach(line => {
                line = line.trim();
                if (line.startsWith('#EXTINF:')) {
                    current = {
                        id: Date.now() + Math.random(),
                        quality: 'SD',
                        category: 'Otros'
                    };
                    
                    // Extraer info
                    const info = line.substring(8);
                    const parts = info.split(',');
                    current.name = parts[parts.length - 1].trim();

                    // Regex para atributos
                    const logoMatch = line.match(/tvg-logo="([^"]*)"/i);
                    if(logoMatch) current.logo = logoMatch[1];

                    const groupMatch = line.match(/group-title="([^"]*)"/i);
                    if(groupMatch) current.category = groupMatch[1];

                    if(current.name.toUpperCase().includes('HD')) current.quality = 'HD';
                    if(current.name.toUpperCase().includes('FHD')) current.quality = 'FHD';
                    if(current.name.toUpperCase().includes('4K')) current.quality = '4K';

                } else if (line && !line.startsWith('#') && current) {
                    current.url = line;
                    channels.push(current);
                    current = null;
                }
            });
            return channels;
        }

        async function loadXtream() {
            const server = document.getElementById('xtreamServer').value.replace(/\/$/, '');
            const user = document.getElementById('xtreamUser').value;
            const pass = document.getElementById('xtreamPass').value;
            const name = document.getElementById('xtreamListName').value || 'Xtream List';

            if(!server || !user || !pass) {
                alert('Faltan datos');
                return;
            }

            showLoading(true, 'Conectando a Xtream...');
            updateStatus('Conectando API...');

            try {
                const apiUrl = `${server}/player_api.php?username=${user}&password=${pass}&action=get_live_streams`;
                // Usar Proxy para la API tambi√©n
                const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(apiUrl);
                
                const resp = await fetch(proxyUrl);
                if(!resp.ok) throw new Error('Error conectando al servidor');
                
                const data = await resp.json();
                if(!Array.isArray(data)) throw new Error('Respuesta inv√°lida del servidor');

                const channels = data.map(c => ({
                    id: c.stream_id,
                    name: c.name,
                    category: c.category_name || 'General',
                    logo: c.stream_icon,
                    url: `${server}/live/${user}/${pass}/${c.stream_id}.m3u8`, // Construir URL directa
                    quality: 'HD' // Asumir HD por defecto
                }));

                const newList = {
                    id: Date.now(),
                    name: name,
                    channels: channels,
                    type: 'xtream',
                    date: new Date().toISOString()
                };

                savedLists.push(newList);
                saveToStorage();
                loadList(newList);
                showSection('home');

            } catch (e) {
                updateStatus('‚ùå Error: ' + e.message);
                alert('Error Xtream: ' + e.message + '. Aseg√∫rate de que el servidor est√© activo.');
            } finally {
                showLoading(false);
            }
        }

        function loadList(list) {
            currentList = list;
            allChannels = list.channels;
            
            // Procesar categor√≠as
            categories = {};
            allChannels.forEach(c => {
                const cat = c.category || 'Otros';
                if(!categories[cat]) categories[cat] = [];
                categories[cat].push(c);
            });

            localStorage.setItem(STORAGE.CURRENT_LIST, JSON.stringify(list));
            
            displayCategories();
            populateFilters();
            applyFilters();
        }

        function loadListById(id) {
            const list = savedLists.find(l => l.id === id);
            if(list) loadList(list);
        }

        function deleteList(id) {
            if(!confirm('¬øBorrar lista?')) return;
            savedLists = savedLists.filter(l => l.id !== id);
            if(currentList && currentList.id === id) {
                currentList = null;
                allChannels = [];
                currentChannels = [];
                document.getElementById('channelsContainer').innerHTML = '';
            }
            saveToStorage();
            displayLists();
        }

        // ==========================================
        // DISPLAY & FILTERS
        // ==========================================

        function toggleCategories() {
            document.getElementById('categoriesList').classList.toggle('expanded');
        }

        function displayCategories() {
            const container = document.getElementById('categoriesList');
            container.innerHTML = '';
            
            Object.keys(categories).sort().forEach(cat => {
                if(blockedCategories.has(cat)) return;

                const div = document.createElement('div');
                div.className = 'category-item';
                div.innerHTML = `<span>${cat}</span> <span class="count">${categories[cat].length}</span>`;
                div.onclick = () => {
                    document.getElementById('categoryFilter').value = cat;
                    applyFilters();
                    showSection('home');
                    // En m√≥vil cerrar sidebar
                    if(window.innerWidth <= 768) toggleSidebar();
                };
                container.appendChild(div);
            });
        }

        function populateFilters() {
            const catSelect = document.getElementById('categoryFilter');
            catSelect.innerHTML = '<option value="">Todas las categor√≠as</option>';
            Object.keys(categories).sort().forEach(cat => {
                if(!blockedCategories.has(cat)) {
                    catSelect.innerHTML += `<option value="${cat}">${cat}</option>`;
                }
            });
        }

        function applyFilters() {
            const cat = document.getElementById('categoryFilter').value;
            const search = document.getElementById('searchInput').value.toLowerCase();

            currentChannels = allChannels.filter(c => {
                if (blockedCategories.has(c.category)) return false;
                if (cat && c.category !== cat) return false;
                if (search && !c.name.toLowerCase().includes(search)) return false;
                return true;
            });

            currentPage = 1;
            displayChannels();
        }

        function displayChannels() {
            const container = document.getElementById('channelsContainer');
            container.className = `channels-container ${currentViewMode}-view`;
            container.innerHTML = '';

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const slice = currentChannels.slice(start, end);

            if(slice.length === 0) {
                container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; padding: 20px; color: #666;">No hay canales para mostrar.</p>';
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            slice.forEach(c => {
                const isFav = favorites.has(c.id);
                const div = document.createElement('div');
                div.className = `channel-card ${currentViewMode}-view`;
                div.onclick = (e) => {
                    // Si no clickeamos un bot√≥n, reproducir
                    if(!e.target.closest('.action-btn')) playChannel(c.id);
                };

                const img = c.logo ? `<img src="${c.logo}" onerror="this.style.display='none'; this.parentElement.innerHTML='üì∫'">` : 'üì∫';

                div.innerHTML = `
                    <div class="channel-logo">${img}</div>
                    <div class="channel-info">
                        <div class="channel-name" title="${c.name}">${c.name}</div>
                        <div class="channel-category">${c.category}</div>
                    </div>
                    <div class="channel-actions">
                        <button class="action-btn favorite ${isFav ? 'active' : ''}" onclick="toggleFavorite(event, ${c.id})">
                            ${isFav ? '‚≠ê' : '‚òÜ'}
                        </button>
                        <button class="action-btn" onclick="playChannel(${c.id})">‚ñ∂ Play</button>
                        <button class="action-btn" onclick="recordChannel(event, ${c.id})">‚è∫</button>
                    </div>
                `;
                container.appendChild(div);
            });

            renderPagination();
        }

        function renderPagination() {
            const container = document.getElementById('pagination');
            container.innerHTML = '';
            const totalPages = Math.ceil(currentChannels.length / itemsPerPage);
            
            if(totalPages <= 1) return;

            const createBtn = (page, text) => {
                const btn = document.createElement('button');
                btn.className = `page-btn ${page === currentPage ? 'active' : ''}`;
                btn.innerText = text || page;
                btn.onclick = () => { currentPage = page; displayChannels(); window.scrollTo(0,0); };
                return btn;
            };

            container.appendChild(createBtn(Math.max(1, currentPage - 1), '‚óÄ'));
            
            // L√≥gica simple de paginaci√≥n
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);

            for(let i = startPage; i <= endPage; i++) {
                container.appendChild(createBtn(i));
            }

            container.appendChild(createBtn(Math.min(totalPages, currentPage + 1), '‚ñ∂'));
        }

        function setViewMode(mode) {
            currentViewMode = mode;
            document.querySelectorAll('.view-mode').forEach(m => m.classList.remove('active'));
            document.querySelector(`.view-mode[title*="${mode === 'grid' ? 'Grid' : 'Lista'}"]`).classList.add('active');
            displayChannels();
        }

        // ==========================================
        // FAVORITES
        // ==========================================
        function toggleFavorite(e, id) {
            e.stopPropagation();
            if(favorites.has(id)) favorites.delete(id);
            else favorites.add(id);
            
            saveToStorage();
            document.getElementById('favCount').innerText = favorites.size;
            
            // Refrescar vista si estamos en favoritos o home
            const activeSec = document.querySelector('.content-section.active').id;
            if(activeSec === 'favoritesSection') displayFavorites();
            else if(activeSec === 'homeSection') displayChannels();
        }

        function displayFavorites() {
            const container = document.getElementById('favoritesContainer');
            container.innerHTML = '';
            const favs = allChannels.filter(c => favorites.has(c.id));
            
            if(favs.length === 0) {
                container.innerHTML = '<p style="text-align: center; width: 100%;">No tienes favoritos a√∫n.</p>';
                return;
            }
            
            favs.forEach(c => {
                // Reutilizamos la l√≥gica visual creando tarjetas manuales simple
                // Idealmente refactorizar createCard, pero por brevedad:
                const div = document.createElement('div');
                div.className = 'channel-card grid-view';
                div.innerHTML = `
                    <div class="channel-logo">${c.logo ? `<img src="${c.logo}" style="max-width:100%;max-height:100%">` : 'üì∫'}</div>
                    <div class="channel-info">
                        <div class="channel-name">${c.name}</div>
                        <div class="channel-category">${c.category}</div>
                    </div>
                    <div class="channel-actions">
                        <button class="action-btn" onclick="playChannel(${c.id})">‚ñ∂ Play</button>
                        <button class="action-btn favorite active" onclick="toggleFavorite(event, ${c.id})">‚≠ê</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // ==========================================
        // PLAY & RECORD
        // ==========================================
        function playChannel(id) {
            const ch = allChannels.find(c => c.id === id);
            if(!ch) return;

            const win = window.open('', '_blank', 'width=1024,height=576,scrollbars=no');
            
            const html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${ch.name}</title>
                    <style>
                        body { margin: 0; background: #000; color: #fff; display: flex; height: 100vh; justify-content: center; align-items: center; font-family: sans-serif; }
                        video { width: 100%; height: 100%; max-height: 100vh; }
                        .controls { position: absolute; top: 10px; left: 10px; z-index: 10; }
                        button { background: rgba(229, 9, 20, 0.8); border: none; color: white; padding: 10px; cursor: pointer; border-radius: 4px; }
                    </style>
                    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"><\/script>
                </head>
                <body>
                    <div class="controls">
                        <button onclick="location.reload()">üîÑ Recargar</button>
                    </div>
                    <video id="video" controls autoplay></video>
                    <script>
                        const video = document.getElementById('video');
                        const url = "${ch.url}"; // Url directa
                        const corsProxy = "https://corsproxy.io/?"; // Proxy p√∫blico

                        function play() {
                            if (Hls.isSupported()) {
                                const hls = new Hls();
                                // Intentamos cargar con Proxy para evitar CORS
                                hls.loadSource(corsProxy + encodeURIComponent(url));
                                hls.attachMedia(video);
                                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                                    video.play();
                                });
                                hls.on(Hls.Events.ERROR, function(event, data) {
                                    console.log("Error HLS:", data);
                                });
                            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                                video.src = url;
                                video.addEventListener('loadedmetadata', function() {
                                    video.play();
                                });
                            }
                        }
                        play();
                    <\/script>
                </body>
                </html>
            `;
            win.document.write(html);
            win.document.close();
        }

        function recordChannel(e, id) {
            if(e) e.stopPropagation();
            alert("‚ÑπÔ∏è Informaci√≥n: Debido a restricciones de seguridad del navegador, no se puede grabar directamente al disco duro. \n\nSi deseas guardar este canal, usa un gestor de descargas externo (como VLC o IDM) con la URL del canal.");
        }

        // ==========================================
        // SEARCH
        // ==========================================
        let searchTimeout;
        function handleSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const query = document.getElementById('searchInput').value;
                const container = document.getElementById('searchSuggestions');
                
                if(!query) {
                    container.classList.remove('active');
                    applyFilters(); // reset
                    return;
                }

                // Sugerencias
                const matches = allChannels.filter(c => c.name.toLowerCase().includes(query.toLowerCase())).slice(0, 5);
                
                if(matches.length > 0) {
                    container.innerHTML = '';
                    matches.forEach(c => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.innerText = c.name;
                        div.onclick = () => {
                            document.getElementById('searchInput').value = c.name;
                            container.classList.remove('active');
                            applyFilters();
                        };
                        container.appendChild(div);
                    });
                    container.classList.add('active');
                } else {
                    container.classList.remove('active');
                }
                
                applyFilters();
            }, 300);
        }

        // ==========================================
        // MANAGEMENT & PARENTAL
        // ==========================================
        function displayLists() {
            const container = document.getElementById('listsContainer');
            container.innerHTML = '';
            
            if(savedLists.length === 0) {
                container.innerHTML = '<p>No hay listas guardadas.</p>';
                return;
            }

            savedLists.forEach(l => {
                const div = document.createElement('div');
                div.className = `list-card ${currentList && currentList.id === l.id ? 'active' : ''}`;
                div.innerHTML = `
                    <h3>${l.name}</h3>
                    <div class="list-stats">
                        <span>${l.channels.length} canales</span>
                        <span>${l.type.toUpperCase()}</span>
                    </div>
                    <div class="list-actions">
                        <button class="btn" onclick="loadListById(${l.id})">Cargar</button>
                        <button class="btn btn-secondary" onclick="deleteList(${l.id})">Borrar</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function displayParentalControls() {
            const container = document.getElementById('parentalCategories');
            container.innerHTML = '';
            
            if(Object.keys(categories).length === 0) {
                container.innerHTML = '<p>Carga una lista primero.</p>';
                return;
            }

            Object.keys(categories).sort().forEach(cat => {
                const isBlocked = blockedCategories.has(cat);
                const div = document.createElement('div');
                div.className = 'category-toggle';
                div.innerHTML = `
                    <span>${cat} (${categories[cat].length})</span>
                    <div class="toggle-switch ${isBlocked ? 'active' : ''}" onclick="toggleBlock('${cat}')"></div>
                `;
                container.appendChild(div);
            });
        }

        function toggleBlock(cat) {
            if(blockedCategories.has(cat)) blockedCategories.delete(cat);
            else blockedCategories.add(cat);
            saveToStorage();
            displayParentalControls();
            // Si estamos en home, refrescar filtros
            populateFilters();
        }

        function saveRecordingPath() {
            alert("La ruta se ha restablecido a la carpeta 'Descargas' predeterminada del navegador.");
        }

        function loadFromStorage() {
            const lsLists = localStorage.getItem(STORAGE.LISTS);
            if(lsLists) savedLists = JSON.parse(lsLists);
            
            const lsFavs = localStorage.getItem(STORAGE.FAVORITES);
            if(lsFavs) favorites = new Set(JSON.parse(lsFavs));
            document.getElementById('favCount').innerText = favorites.size;

            const lsBlocked = localStorage.getItem(STORAGE.BLOCKED_CATS);
            if(lsBlocked) blockedCategories = new Set(JSON.parse(lsBlocked));

            const lsCurrent = localStorage.getItem(STORAGE.CURRENT_LIST);
            if(lsCurrent) {
                try {
                    const parsed = JSON.parse(lsCurrent);
                    // Verificar si existe aun
                    if(savedLists.find(l => l.id === parsed.id)) {
                        loadList(parsed);
                    }
                } catch(e) { console.log("Error cargando lista anterior"); }
            }
        }

        function saveToStorage() {
            localStorage.setItem(STORAGE.LISTS, JSON.stringify(savedLists));
            localStorage.setItem(STORAGE.FAVORITES, JSON.stringify([...favorites]));
            localStorage.setItem(STORAGE.BLOCKED_CATS, JSON.stringify([...blockedCategories]));
        }

        // Cerrar sugerencias al clickear fuera
        document.addEventListener('click', (e) => {
            if(!e.target.closest('.search-container')) {
                document.getElementById('searchSuggestions').classList.remove('active');
            }
        });

    </script>
</body>
</html>