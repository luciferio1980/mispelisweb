<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor IPTV Avanzado</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0d1117; color: #c9d1d9; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 1rem; }
        .container { background-color: #161b22; border: 1px solid #30363d; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5); max-width: 900px; width: 100%; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; height: auto; }
        .video-player-container { position: relative; width: 100%; padding-top: 56.25%; background-color: #000; }
        .video-player { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; background-color: #000; }
        .message-box { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #21262d; color: #c9d1d9; padding: 1.5rem; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.6); z-index: 1000; display: none; flex-direction: column; align-items: center; text-align: center; border: 1px solid #30363d; max-width: 350px; }
        .message-box.show { display: flex; }
        .message-box .title { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; }
        .message-box .message { margin-bottom: 1.5rem; }
        .message-box button { background-color: #238636; color: #ffffff; font-weight: 600; padding: 0.5rem 1.5rem; border-radius: 6px; transition: background-color 0.2s; }
        .message-box button:hover { background-color: #2ea043; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal.show { display: flex; }
        .modal-content { background-color: #161b22; border: 1px solid #30363d; border-radius: 12px; padding: 2rem; width: 90%; max-width: 800px; height: 90vh; display: flex; flex-direction: column; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.8); transform: scale(0.95); transition: transform 0.3s ease-in-out; }
        .modal.show .modal-content { transform: scale(1); }
        .content-list { flex-grow: 1; overflow-y: auto; margin-top: 1rem; padding-right: 0.5rem; }
        .channel-list-item { cursor: pointer; padding: 0.75rem; border-bottom: 1px solid #30363d; transition: background-color 0.2s; display: flex; align-items: center; }
        .channel-list-item:hover { background-color: #21262d; }
        .channel-list-item img { width: 2.5rem; height: 2.5rem; margin-right: 1rem; border-radius: 50%; object-fit: cover; background-color: #30363d; }
        .tab-button { padding: 0.75rem 1.5rem; border-radius: 8px 8px 0 0; font-weight: 600; background-color: #21262d; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .tab-button.active { background-color: #161b22; border-bottom: 2px solid #58a6ff; color: #58a6ff; }
        .initial-menu { display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; width: 100%; max-width: 900px; }
        .collapsible-header { cursor: pointer; padding: 1rem; background-color: #21262d; font-weight: 600; display: flex; justify-content: space-between; align-items: center; border-radius: 8px; margin-top: 0.5rem; transition: background-color 0.2s; }
        .collapsible-header:hover { background-color: #30363d; }
        .collapsible-header .fas { transition: transform 0.3s; }
        .collapsible-header.active .fas { transform: rotate(180deg); }
        .collapsible-content { padding-left: 1rem; overflow: hidden; transition: max-height 0.3s ease-in-out; max-height: 0; }
        .collapsible-content.show { max-height: 10000px; }
        .progress-container { display: flex; flex-direction: column; align-items: center; margin-top: 1rem; width: 100%; }
        .progress-bar { width: 100%; height: 8px; background-color: #30363d; border-radius: 4px; overflow: hidden; margin-top: 0.5rem; }
        .progress-bar-fill { height: 100%; width: 0%; background-color: #58a6ff; transition: width 0.3s ease; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased leading-tight">

    <div id="initialMenu" class="initial-menu">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-white mb-6">Reproductor IPTV Avanzado</h1>
        <p class="text-lg sm:text-xl text-gray-400 mb-8 max-w-sm" id="statusMessage">Selecciona una opción.</p>
        <div class="flex flex-col space-y-4 w-full max-w-xs mb-8">
            <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-transform transform hover:scale-105" data-action="show-content-list" data-content-type="live"><i class="fas fa-satellite-dish mr-2"></i>Live TV</button>
            <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-transform transform hover:scale-105" data-action="show-content-list" data-content-type="movies"><i class="fas fa-film mr-2"></i>Películas</button>
            <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-transform transform hover:scale-105" data-action="show-content-list" data-content-type="series"><i class="fas fa-tv mr-2"></i>Series</button>
        </div>
        <button class="absolute top-4 right-4 text-white text-2xl p-2 rounded-full hover:bg-gray-700 transition-colors" data-action="show-settings"><i class="fas fa-cog"></i></button>
    </div>

    <div id="mainApp" class="container hidden">
        <header class="flex justify-between items-center p-4 border-b border-gray-700">
            <h1 class="text-2xl font-bold text-white">Reproductor</h1>
            <div class="flex items-center space-x-2">
                <button class="text-white text-xl p-2 rounded-full hover:bg-gray-700 transition-colors" data-action="show-initial-menu"><i class="fas fa-arrow-left"></i></button>
                <button class="text-white text-xl p-2 rounded-full hover:bg-gray-700 transition-colors" data-action="show-content-list-modal"><i class="fas fa-bars"></i></button>
            </div>
        </header>

        <div id="videoContainer" class="video-player-container rounded-t-lg">
            <video id="videoPlayer" class="video-player rounded-t-lg" controls autoplay></video>
        </div>

        <div id="welcomeMessage" class="flex-grow flex items-center justify-center p-8 text-center">
            <p class="text-xl text-gray-400">Selecciona un canal para empezar a reproducir.</p>
        </div>

        <div id="controlsContainer" class="p-4 flex-col sm:flex-row items-center justify-between hidden">
            <div class="flex-1 text-center sm:text-left mb-4 sm:mb-0">
                <h2 id="channelName" class="text-xl font-semibold"></h2>
                <p id="channelDescription" class="text-gray-400"></p>
            </div>
        </div>
    </div>
    
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-white mb-4">Opciones de Contenido</h2>
            <div class="flex justify-center -mt-4 mb-4">
                <button id="m3uTab" class="tab-button active" data-action="switch-tab" data-tab-name="m3u">URL M3U</button>
                <button id="xtremioTab" class="tab-button" data-action="switch-tab" data-tab-name="xtremio">Xtremio</button>
            </div>
            <div id="m3uPanel" class="tab-panel flex flex-col flex-grow">
                <p class="text-gray-400 mb-4">Pega la URL de tu lista `.m3u` o `.m3u8`.</p>
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-4">
                    <input type="text" id="m3uUrlInput" placeholder="https://example.com/playlist.m3u8" class="flex-1 bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-md p-2 focus:outline-none focus:border-blue-500">
                    <button id="loadM3uBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-md shadow-lg transition-colors" data-action="load-m3u"><i class="fas fa-cloud-download-alt mr-2"></i>Cargar</button>
                </div>
                <div id="m3uProgress" class="progress-container hidden">
                    <p id="m3uProgressText" class="text-sm text-gray-400">Cargando...</p>
                    <div class="progress-bar"><div id="m3uProgressBarFill" class="progress-bar-fill"></div></div>
                </div>
            </div>
            <div id="xtremioPanel" class="tab-panel hidden flex flex-col flex-grow">
                <p class="text-gray-400 mb-4">Ingresa tus credenciales de Xtremio.</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <input type="text" id="xtremioServer" placeholder="http://servidor:puerto" class="col-span-2 bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-md p-2 focus:outline-none focus:border-blue-500">
                    <input type="text" id="xtremioUsername" placeholder="Usuario" class="bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-md p-2 focus:outline-none focus:border-blue-500">
                    <input type="password" id="xtremioPassword" placeholder="Contraseña" class="bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-md p-2 focus:outline-none focus:border-blue-500">
                </div>
                <button id="loadXtremioBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-md shadow-lg transition-colors" data-action="load-xtremio"><i class="fas fa-sign-in-alt mr-2"></i>Conectar y Cargar</button>
                <div id="xtremioProgress" class="progress-container hidden">
                    <p id="xtremioProgressText" class="text-sm text-gray-400">Cargando...</p>
                    <div class="progress-bar"><div id="xtremioProgressBarFill" class="progress-bar-fill"></div></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="contentListModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-white mb-4">Biblioteca de Contenido</h2>
            <div class="flex justify-center -mt-4 mb-4">
                <button id="liveContentTab" class="tab-button active" data-action="switch-content-tab" data-content-type="live">Live TV</button>
                <button id="moviesContentTab" class="tab-button" data-action="switch-content-tab" data-content-type="movies">Películas</button>
                <button id="seriesContentTab" class="tab-button" data-action="switch-content-tab" data-content-type="series">Series</button>
            </div>
            <div id="livePanel" class="content-panel h-full"><div id="liveList" class="content-list"></div></div>
            <div id="moviesPanel" class="content-panel hidden h-full"><p class="text-gray-400 text-center py-4">Función de películas no implementada.</p></div>
            <div id="seriesPanel" class="content-panel hidden h-full"><p class="text-gray-400 text-center py-4">Función de series no implementada.</p></div>
        </div>
    </div>

    <script type="module">
        // --- VARIABLES GLOBALES ---
        let liveChannels = [];
        let movies = [];
        let series = [];
        let hls; // Instancia para HLS.js
        let currentContentType = 'live';

        // --- REFERENCIAS AL DOM ---
        const mainApp = document.getElementById('mainApp');
        const initialMenu = document.getElementById('initialMenu');
        const videoContainer = document.getElementById('videoContainer');
        const videoPlayer = document.getElementById('videoPlayer');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const controlsContainer = document.getElementById('controlsContainer');
        const contentListModal = document.getElementById('contentListModal');
        const settingsModal = document.getElementById('settingsModal');

        // --- FUNCIONES DE REPRODUCCIÓN ---
        /**
         * Reproduce un stream HLS (.m3u8) usando HLS.js
         * @param {string} url La URL del stream.
         */
        function playStream(url) {
            if (hls) {
                hls.destroy(); // Destruye la instancia anterior para limpiar
            }
            if (Hls.isSupported()) {
                hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoPlayer);
                hls.on(Hls.Events.MANIFEST_PARSED, () => videoPlayer.play());
            } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                // Soporte nativo en navegadores como Safari
                videoPlayer.src = url;
            }
            videoContainer.classList.remove('hidden');
            welcomeMessage.classList.add('hidden');
        }
        
        // --- FUNCIONES DE CARGA Y PARSEO ---
        /**
         * Parsea el texto de un archivo M3U y lo convierte en un array de objetos.
         * @param {string} text Contenido del archivo M3U.
         */
        function parseM3u(text) {
            liveChannels = [];
            const lines = text.split('\n');
            let currentChannel = {};
            for (const line of lines) {
                if (line.startsWith('#EXTINF:')) {
                    const name = line.substring(line.lastIndexOf(',') + 1).trim();
                    const logoMatch = line.match(/tvg-logo="([^"]*)"/);
                    const groupMatch = line.match(/group-title="([^"]*)"/);
                    currentChannel = {
                        name: name,
                        logo: logoMatch ? logoMatch[1] : 'https://via.placeholder.com/150/161b22/FFFFFF?text=TV',
                        group: groupMatch ? groupMatch[1] : 'General',
                        url: null
                    };
                } else if (line.trim() && !line.startsWith('#')) {
                    if (currentChannel.name) {
                        currentChannel.url = line.trim();
                        liveChannels.push(currentChannel);
                        currentChannel = {};
                    }
                }
            }
        }

        /**
         * Carga una lista M3U desde una URL, mostrando el progreso.
         */
        async function loadM3uList() {
            const m3uUrl = document.getElementById('m3uUrlInput')?.value.trim();
            const progressContainer = document.getElementById('m3uProgress');
            const progressBarFill = document.getElementById('m3uProgressBarFill');
            const progressText = document.getElementById('m3uProgressText');
            
            if (!m3uUrl) { showMessage('Error', 'Por favor, ingresa una URL válida.'); return; }

            progressContainer.classList.remove('hidden');
            progressBarFill.style.width = '0%';
            progressText.textContent = 'Contactando servidor...';
            
            try {
                const response = await fetch(m3uUrl);
                progressBarFill.style.width = '30%';
                if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                
                progressText.textContent = 'Descargando lista...';
                const text = await response.text();
                progressBarFill.style.width = '70%';
                
                progressText.textContent = 'Procesando canales...';
                parseM3u(text);
                
                progressBarFill.style.width = '100%';
                progressText.textContent = '¡Carga completa!';

                setTimeout(() => {
                    hideSettingsModal();
                    renderLiveChannels();
                    showContentListModal('live');
                    progressContainer.classList.add('hidden');
                }, 500);

            } catch (error) {
                progressText.textContent = 'Error al cargar. Revisa la URL y la consola.';
                progressBarFill.style.backgroundColor = '#e3342f';
                console.error('Error al cargar la lista .m3u:', error);
            }
        }

        // --- FUNCIONES DE LA UI (RENDERIZADO) ---
        /**
         * Muestra los canales de TV en vivo en la lista, agrupados por categoría.
         */
        function renderLiveChannels() {
            const liveList = document.getElementById('liveList');
            liveList.innerHTML = '';
            if (liveChannels.length === 0) {
                liveList.innerHTML = '<p class="text-gray-400 text-center py-4">No hay canales. Carga una lista M3U o Xtremio.</p>';
                return;
            }

            const groups = liveChannels.reduce((acc, channel) => {
                (acc[channel.group] = acc[channel.group] || []).push(channel);
                return acc;
            }, {});

            Object.keys(groups).sort().forEach(groupName => {
                const header = document.createElement('div');
                header.className = 'collapsible-header';
                header.innerHTML = `<span>${groupName} (${groups[groupName].length})</span> <i class="fas fa-chevron-down"></i>`;
                
                const content = document.createElement('div');
                content.className = 'collapsible-content';
                
                groups[groupName].forEach(channel => {
                    const item = document.createElement('div');
                    item.className = 'channel-list-item';
                    item.innerHTML = `<img src="${channel.logo}" alt=""><span>${channel.name}</span>`;
                    item.onclick = () => {
                        playStream(channel.url);
                        hideContentListModal();
                        document.getElementById('channelName').textContent = channel.name;
                        document.getElementById('channelDescription').textContent = `Grupo: ${channel.group}`;
                        controlsContainer.classList.remove('hidden');
                    };
                    content.appendChild(item);
                });

                header.onclick = () => {
                    header.classList.toggle('active');
                    content.classList.toggle('show');
                };

                liveList.appendChild(header);
                liveList.appendChild(content);
            });
        }
        
        // --- FUNCIONES DE LA UI (MANEJO DE MODALES Y PESTAÑAS) ---
        function showMessage(title, message) { /* ... sin cambios ... */ }
        function hideMessage() { /* ... sin cambios ... */ }
        function showInitialMenu() { mainApp.classList.add('hidden'); initialMenu.classList.remove('hidden'); }
        function showSettingsModal() { settingsModal.classList.add('show'); }
        function hideSettingsModal() { settingsModal.classList.remove('show'); }
        function showContentListModal(contentType = 'live') {
            currentContentType = contentType;
            initialMenu.classList.add('hidden');
            mainApp.classList.remove('hidden');
            contentListModal.classList.add('show');
            switchContentTab(contentType);
        }
        function hideContentListModal() { contentListModal.classList.remove('show'); }
        function switchTab(tabName) {
            document.getElementById('m3uTab').classList.toggle('active', tabName === 'm3u');
            document.getElementById('xtremioTab').classList.toggle('active', tabName === 'xtremio');
            document.getElementById('m3uPanel').classList.toggle('hidden', tabName !== 'm3u');
            document.getElementById('xtremioPanel').classList.toggle('hidden', tabName !== 'xtremio');
        }
        function switchContentTab(tabName) {
            document.getElementById('liveContentTab').classList.toggle('active', tabName === 'live');
            document.getElementById('moviesContentTab').classList.toggle('active', tabName === 'movies');
            document.getElementById('seriesContentTab').classList.toggle('active', tabName === 'series');
            document.getElementById('livePanel').classList.toggle('hidden', tabName !== 'live');
            document.getElementById('moviesPanel').classList.toggle('hidden', tabName !== 'movies');
            document.getElementById('seriesPanel').classList.toggle('hidden', tabName !== 'series');
        }

        // --- MANEJADOR DE EVENTOS GLOBAL ---
        document.addEventListener('click', (e) => {
            const actionTarget = e.target.closest('[data-action]');
            if (e.target.classList.contains('modal')) { e.target.classList.remove('show'); }
            if (!actionTarget) return;

            const action = actionTarget.dataset.action;
            switch (action) {
                case 'show-settings': showSettingsModal(); break;
                case 'show-content-list': showContentListModal(actionTarget.dataset.contentType); break;
                case 'show-initial-menu': showInitialMenu(); break;
                case 'show-content-list-modal': showContentListModal(currentContentType); break;
                case 'switch-tab': switchTab(actionTarget.dataset.tabName); break;
                case 'switch-content-tab': switchContentTab(actionTarget.dataset.contentType); break;
                case 'load-m3u': loadM3uList(); break;
                case 'load-xtremio': alert('Función Xtremio no implementada en este ejemplo.'); break;
            }
        });
    </script>
</body>
</html>