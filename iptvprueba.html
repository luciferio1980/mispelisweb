<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamFlix Player - Cloud Recording v5.3.1 (EPG Fix)</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap');
        
        :root { --bg-main: #141414; --accent: #e50914; --text-main: #ffffff; --text-secondary: #b3b3b3; }
        body { font-family: 'Montserrat', sans-serif; background-color: #000; color: var(--text-main); overflow: hidden; margin: 0; padding: 0; }
        
        #globalBackground { position: fixed; inset: 0; z-index: -1; background-image: url('https://assets.nflxext.com/ffe/siteui/vlv3/f841d4c7-10e1-40af-bcae-07a3f8dc141a/f6d7434e-d6de-4185-a6d4-c77a2d08737b/US-en-20220502-popsignuptwoweeks-perspective_alpha_website_medium.jpg'); background-size: cover; background-position: center; }
        #globalOverlay { position: fixed; inset: 0; z-index: -1; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #666; }

        .poster-card { transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94), z-index 0.3s; position: relative; z-index: 1; aspect-ratio: 2/3; cursor: pointer; border-radius: 6px; overflow: hidden; background-color: #1f1f1f; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .poster-fallback { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; padding: 8px; text-align: center; background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%); z-index: 0; }
        .poster-fallback span { font-size: 11px; font-weight: 600; color: #555; text-transform: uppercase; line-height: 1.2; max-height: 100%; overflow: hidden; }
        .poster-img { width: 100%; height: 100%; position: relative; z-index: 10; transition: opacity 0.3s ease; background: transparent; }
        .poster-img.img-error { opacity: 0 !important; } 
        .poster-card:hover { transform: scale(1.1); z-index: 50; box-shadow: 0 10px 30px rgba(0,0,0,0.9); outline: 2px solid white; }
        .poster-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.2) 60%); opacity: 0; transition: opacity 0.3s; display: flex; flex-direction: column; justify-content: flex-end; padding: 10px; z-index: 20; }
        .poster-card:hover .poster-overlay { opacity: 1; }
        
        .list-item { display: flex; align-items: center; padding: 10px; background-color: rgba(30,30,30,0.8); border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: background-color 0.2s; border-radius: 4px; margin-bottom: 4px; }
        .list-item:hover { background-color: rgba(255,255,255,0.1); }
        .list-item img { width: 45px; height: 45px; object-fit: contain; border-radius: 4px; margin-right: 15px; background: #000; }
        
        .cat-chip { white-space: nowrap; padding: 6px 14px; background-color: rgba(50,50,50,0.7); border-radius: 20px; font-size: 13px; cursor: pointer; transition: all 0.2s; user-select: none; border: 1px solid transparent; backdrop-filter: blur(4px); }
        .cat-chip:hover { background-color: rgba(80,80,80,0.9); }
        .cat-chip.active { background-color: var(--accent); color: white; font-weight: bold; border-color: var(--accent); }
        .hide-scroll::-webkit-scrollbar { display: none; }
        
        .nav-item.active { color: white; border-right: 3px solid var(--accent); font-weight: bold; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05)); }
        .nav-item { color: var(--text-secondary); transition: color 0.2s; }
        .nav-item:hover { color: white; }

        .custom-controls { pointer-events: none; overflow: hidden; }
        .player-wrapper.active-ui .custom-controls { pointer-events: auto; }
        .osd-panel { transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.6s ease; opacity: 1; transform: translateY(0); }
        .player-wrapper:not(.active-ui) .osd-top { transform: translateY(-150%); opacity: 0; }
        .player-wrapper:not(.active-ui) .osd-bottom { transform: translateY(150%); opacity: 0; }
        
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: var(--accent); cursor: pointer; margin-top: -6px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #555; border-radius: 2px; }
        
        .rec-dot { display: inline-block; width: 10px; height: 10px; background-color: red; border-radius: 50%; margin-right: 5px; animation: pulse-red 1s infinite; }
        @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        .loader { border: 4px solid rgba(255,255,255,0.1); width: 50px; height: 50px; border-radius: 50%; border-left-color: var(--accent); animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .content-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 0.8rem; padding-bottom: 50px; }
        @media (min-width: 1024px) { .content-grid { grid-template-columns: repeat(auto-fill, minmax(145px, 1fr)); gap: 1.2rem; } }
        .content-grid.list-layout { display: flex; flex-direction: column; gap: 0; }

        .detail-modal { background-color: #181818; box-shadow: 0 0 50px rgba(0,0,0,0.9); }
        .settings-modal { background-color: #222; border: 1px solid #444; }

        /* Estilos del indicador de grabación de fondo */
        #recordingIndicator { animation: slideUp 0.5s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body class="flex h-screen w-screen bg-black">
    <div id="globalBackground"></div>
    <div id="globalOverlay"></div>

    <div id="loginScreen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-black" style="background-image: url('https://assets.nflxext.com/ffe/siteui/vlv3/f841d4c7-10e1-40af-bcae-07a3f8dc141a/f6d7434e-d6de-4185-a6d4-c77a2d08737b/US-en-20220502-popsignuptwoweeks-perspective_alpha_website_medium.jpg'); background-size: cover; background-blend-mode: multiply;">
        <div class="bg-black bg-opacity-80 p-10 rounded-lg max-w-md w-full shadow-2xl border border-gray-800">
            <h1 class="text-4xl font-bold text-red-600 mb-8 text-center uppercase tracking-widest">StreamFlix</h1>
            <div class="flex space-x-2 mb-6 border-b border-gray-700">
                <button id="tabM3u" class="flex-1 pb-2 text-white border-b-2 border-red-600 font-medium transition">M3U URL</button>
                <button id="tabXtream" class="flex-1 pb-2 text-gray-400 hover:text-white transition">Xtream Codes</button>
            </div>
            <div id="panelM3u" class="space-y-4">
                <input type="text" id="m3uInput" placeholder="Pega tu enlace M3U aquí..." class="w-full bg-[#333] text-white p-3 rounded outline-none focus:bg-[#444]">
                <button onclick="app.loadSource('m3u')" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded transition">Entrar</button>
            </div>
            <div id="panelXtream" class="space-y-4 hidden">
                <input type="text" id="xServer" placeholder="http://dominio.com:port" class="w-full bg-[#333] text-white p-3 rounded outline-none focus:bg-[#444]">
                <input type="text" id="xUser" placeholder="Usuario" class="w-full bg-[#333] text-white p-3 rounded outline-none focus:bg-[#444]">
                <input type="password" id="xPass" placeholder="Contraseña" class="w-full bg-[#333] text-white p-3 rounded outline-none focus:bg-[#444]">
                <button onclick="app.loadSource('xtream')" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded transition">Entrar</button>
            </div>
            <div id="loginStatus" class="mt-4 text-sm text-center text-gray-400 min-h-[20px]"></div>
            <div class="mt-6 pt-4 border-t border-gray-700 flex justify-between text-xs text-gray-500">
                <button onclick="app.clearData()" class="hover:text-white underline">Borrar Datos</button>
                <span>v5.3.1 CloudRec</span>
            </div>
        </div>
    </div>

    <div id="mainInterface" class="flex w-full h-full hidden">
        <nav class="w-20 lg:w-64 bg-black bg-opacity-90 backdrop-blur flex-shrink-0 flex flex-col border-r border-[#222] z-20">
            <div class="h-20 flex items-center justify-center lg:justify-start lg:px-6">
                <span class="text-red-600 font-bold text-2xl lg:text-3xl tracking-tighter">FLIX</span>
            </div>
            <div class="flex flex-col space-y-2 mt-4 px-2">
                <button onclick="app.nav('home')" id="nav-home" class="nav-item active flex items-center p-3 rounded-md hover:bg-white/10"><i class="fas fa-home text-xl w-8 text-center"></i><span class="hidden lg:block ml-3">Inicio</span></button>
                <button onclick="app.nav('live')" id="nav-live" class="nav-item flex items-center p-3 rounded-md hover:bg-white/10"><i class="fas fa-broadcast-tower text-xl w-8 text-center"></i><span class="hidden lg:block ml-3">TV en Vivo</span></button>
                <button onclick="app.nav('epg')" id="nav-epg" class="nav-item flex items-center p-3 rounded-md hover:bg-white/10"><i class="fas fa-calendar-alt text-xl w-8 text-center"></i><span class="hidden lg:block ml-3">Guía EPG</span></button>
                <button onclick="app.nav('movies')" id="nav-movies" class="nav-item flex items-center p-3 rounded-md hover:bg-white/10"><i class="fas fa-film text-xl w-8 text-center"></i><span class="hidden lg:block ml-3">Películas</span></button>
                <button onclick="app.nav('series')" id="nav-series" class="nav-item flex items-center p-3 rounded-md hover:bg-white/10"><i class="fas fa-tv text-xl w-8 text-center"></i><span class="hidden lg:block ml-3">Series</span></button>
                <button onclick="app.nav('favorites')" id="nav-favorites" class="nav-item flex items-center p-3 rounded-md hover:bg-white/10"><i class="fas fa-heart text-xl w-8 text-center"></i><span class="hidden lg:block ml-3">Favoritos</span></button>
                <button onclick="app.openSettings()" id="nav-settings" class="nav-item flex items-center p-3 rounded-md hover:bg-white/10"><i class="fas fa-cog text-xl w-8 text-center"></i><span class="hidden lg:block ml-3">Ajustes</span></button>
            </div>
            <div class="mt-auto mb-6 px-2">
                <button onclick="location.reload()" class="nav-item flex items-center p-3 w-full rounded-md hover:bg-white/10"><i class="fas fa-sign-out-alt text-xl w-8 text-center"></i><span class="hidden lg:block ml-3">Salir</span></button>
            </div>
        </nav>

        <main class="flex-grow relative overflow-hidden flex flex-col bg-transparent">
            <header class="absolute top-0 left-0 right-0 h-16 bg-gradient-to-b from-black to-transparent z-10 flex items-center justify-between px-8">
                <div class="flex items-center bg-black bg-opacity-60 border border-gray-700 rounded-full px-3 py-1">
                    <i class="fas fa-search text-gray-400"></i>
                    <input type="text" id="searchInput" placeholder="Buscar..." class="bg-transparent border-none text-white px-3 py-1 outline-none text-sm w-40 lg:w-64 focus:w-80 transition-all">
                </div>
                <div class="text-sm font-medium text-gray-300" id="clock">12:00</div>
            </header>

            <div id="contentArea" class="flex-grow overflow-y-auto overflow-x-hidden relative pt-20">
                <div id="liveToolbar" class="hidden px-6 lg:px-10 mb-4 flex flex-col space-y-4">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-bold text-white">Categorías</h2>
                        <button onclick="app.toggleLayout()" class="text-gray-400 hover:text-white p-2 rounded bg-black/50 flex items-center"><i class="fas fa-th-large mr-2" id="layoutIcon"></i><span class="text-sm" id="layoutText">Grid</span></button>
                    </div>
                    <div id="categoryList" class="flex overflow-x-auto space-x-3 pb-2 hide-scroll"></div>
                </div>

                <div id="heroSection" class="relative w-full h-[60vh] hidden -mt-20">
                    <img id="heroImage" src="" class="w-full h-full object-cover opacity-60">
                    <div class="absolute inset-0 bg-gradient-to-t from-[#0a0a0a] via-transparent to-black"></div>
                    <div class="absolute bottom-0 left-0 p-8 lg:p-16 max-w-2xl">
                        <h1 id="heroTitle" class="text-4xl lg:text-6xl font-extrabold mb-4 text-shadow drop-shadow-lg">Título Destacado</h1>
                        <p id="heroDesc" class="text-gray-300 mb-6 line-clamp-3 text-sm lg:text-base">Descripción...</p>
                        <div class="flex space-x-4">
                            <button id="heroPlayBtn" class="bg-white text-black font-bold py-2 px-6 rounded flex items-center hover:bg-opacity-80 transition"><i class="fas fa-play mr-2"></i> Reproducir</button>
                        </div>
                    </div>
                </div>

                <div id="epgSection" class="px-6 lg:px-10 hidden">
                    <h2 class="text-xl font-bold mb-4 text-white">Guía de Programación (EPG)</h2>
                    <div id="epgControls" class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-3 mb-6 p-3 rounded-lg bg-gray-900/50 overflow-x-auto hide-scroll">
                        <button id="daySelector" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded font-bold text-white flex-shrink-0">Hoy</button>
                        <div id="hourSelector" class="flex overflow-x-auto space-x-2 hide-scroll flex-grow">
                            </div>
                    </div>
                    <div id="epgList" class="space-y-4 pb-20"></div>
                </div>
                <div id="gridSection" class="p-6 lg:p-10">
                    <h2 id="sectionTitle" class="text-xl font-bold mb-4 text-white">Tendencias</h2>
                    <div id="gridContainer" class="content-grid"></div>
                    <div id="loadMoreTrigger" class="h-20 w-full flex items-center justify-center text-gray-500 text-sm">Cargando más contenido...</div>
                </div>
            </div>
            
            <div id="recordingIndicator" class="absolute bottom-0 left-0 right-0 bg-red-900 bg-opacity-95 border-t-2 border-red-600 p-3 hidden flex justify-between items-center z-40">
                <div class="flex items-center space-x-3">
                    <div class="rec-dot w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                    <div class="flex flex-col">
                        <span class="font-bold text-white text-sm">GRABANDO EN SEGUNDO PLANO</span>
                        <span id="recBackgroundTitle" class="text-xs text-red-200">Canal TV</span>
                    </div>
                </div>
                <div class="flex space-x-3">
                    <button onclick="player.restore()" class="bg-gray-800 hover:bg-gray-700 text-white text-xs px-3 py-2 rounded uppercase font-bold">Ver Video</button>
                    <button onclick="player.stopBackground()" class="bg-white text-red-900 hover:bg-gray-200 text-xs px-3 py-2 rounded uppercase font-bold"><i class="fas fa-stop mr-1"></i> Detener</button>
                </div>
            </div>
        </main>
    </div>

    <div id="videoOverlay" class="fixed inset-0 bg-black z-50 hidden flex items-center justify-center player-wrapper active-ui">
        <video id="mainVideo" class="w-full h-full object-contain bg-black" crossorigin="anonymous"></video>
        <div id="bufferingSpinner" class="absolute pointer-events-none hidden"><div class="loader"></div></div>

        <div class="custom-controls absolute inset-0 flex flex-col justify-between p-4 lg:p-8">
            <div class="flex justify-between items-start osd-panel osd-top">
                <div class="flex items-center space-x-4">
                    <button onclick="player.close()" class="text-white text-2xl hover:text-gray-300"><i class="fas fa-arrow-left"></i></button>
                    <button id="btnRecord" onclick="player.toggleRecording()" class="hidden bg-gray-800 bg-opacity-70 hover:bg-gray-700 text-white px-4 py-1 rounded-full flex items-center space-x-2 border border-gray-600 transition">
                        <div id="recDot" class="w-3 h-3 bg-red-600 rounded-full"></div>
                        <span id="recText" class="text-xs font-bold uppercase">Grabar</span>
                    </button>
                </div>
                <div class="text-right">
                    <h3 id="playerTitle" class="text-lg font-bold text-shadow">Título</h3>
                    <div id="playerEpg" class="text-sm text-gray-400"></div>
                </div>
            </div>
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <i id="centerPlayIcon" class="fas fa-play text-6xl opacity-0 transition-opacity duration-500"></i>
            </div>
            <div class="bg-gradient-to-t from-black to-transparent pb-2 pt-10 px-2 rounded-b-lg osd-panel osd-bottom">
                <div class="relative group h-2 bg-gray-600 rounded cursor-pointer mb-4" id="progressBarContainer">
                    <div id="progressBarFill" class="absolute top-0 left-0 h-full bg-red-600 rounded z-10" style="width: 0%"></div>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-6">
                        <button id="btnPlayPause" class="text-white hover:text-red-500 text-2xl"><i class="fas fa-play"></i></button>
                        <button onclick="player.rewind()" class="text-white hover:text-gray-300"><i class="fas fa-undo-10"></i></button>
                        <button onclick="player.forward()" class="text-white hover:text-gray-300"><i class="fas fa-redo-10"></i></button>
                        <div class="flex items-center group relative">
                            <button id="btnMute" class="text-white hover:text-gray-300 text-xl"><i class="fas fa-volume-up"></i></button>
                            <input type="range" min="0" max="1" step="0.1" id="volSlider" class="w-20 ml-2 h-1 accent-red-600 opacity-0 group-hover:opacity-100 transition-opacity">
                        </div>
                        <span id="timeDisplay" class="text-xs text-gray-400 font-mono">00:00</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="player.toggleFullscreen()" class="text-white hover:text-gray-300 text-xl"><i class="fas fa-expand"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="detailModal" class="fixed inset-0 z-40 bg-black bg-opacity-80 hidden items-center justify-center p-4">
        <div class="detail-modal w-full max-w-5xl max-h-[90vh] rounded-lg overflow-hidden flex flex-col md:flex-row relative animate-fade-in-up">
            <button onclick="app.closeDetail()" class="absolute top-4 right-4 z-50 bg-black bg-opacity-50 rounded-full p-2 text-white hover:bg-white hover:text-black transition"><i class="fas fa-times"></i></button>
            <div id="detailContent" class="flex flex-col md:flex-row w-full h-full overflow-hidden bg-[#181818]"></div>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 z-[60] bg-black bg-opacity-90 hidden items-center justify-center p-4">
        <div class="settings-modal w-full max-w-md p-6 rounded-lg relative">
            <button onclick="app.closeSettings()" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            <h2 class="text-2xl font-bold mb-6 text-white border-b border-gray-700 pb-2">Ajustes</h2>
            
            <div class="space-y-6">
                <div>
                    <h3 class="text-gray-300 font-medium mb-2"><i class="fab fa-google-drive mr-2 text-blue-500"></i>Grabación en Nube</h3>
                    <p class="text-xs text-gray-500 mb-3">Conecta tu cuenta de Google para guardar las grabaciones en Drive automáticamente al terminar.</p>
                    <div class="flex flex-col space-y-2">
                        <div id="driveStatus" class="text-sm text-gray-500 bg-[#333] p-2 rounded">
                            <i class="fas fa-circle-notch mr-2"></i> No conectado
                        </div>
                        <button onclick="drive.login()" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded transition flex items-center justify-center">
                            <i class="fab fa-google mr-2"></i> Conectar Drive
                        </button>
                    </div>
                </div>
                
                <div class="border-t border-gray-700 pt-4">
                    <h3 class="text-gray-300 font-medium mb-2">Nota sobre Otros Servidores</h3>
                    <p class="text-xs text-gray-500">Actualmente, la grabación en nube está optimizada e integrada únicamente con **Google Drive** usando su API de autenticación. Implementar otros servicios como Dropbox o OneDrive requeriría una integración de APIs completamente separada y compleja.</p>
                </div>
                <div class="border-t border-gray-700 pt-4">
                    <h3 class="text-gray-300 font-medium mb-2">Ruta Local (PC)</h3>
                    <p class="text-xs text-gray-500 mb-3">Opción alternativa para guardar en disco local.</p>
                    <div class="flex flex-col space-y-2">
                        <div id="folderStatus" class="text-sm text-yellow-500 bg-[#333] p-2 rounded">
                            <i class="fas fa-folder mr-2"></i> Por defecto (Descargas)
                        </div>
                        <button onclick="recorder.pickFolder()" class="bg-gray-700 hover:bg-gray-600 text-white py-2 px-4 rounded transition flex items-center justify-center">
                            <i class="fas fa-folder-open mr-2"></i> Cambiar Ruta
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="uploadProgressModal" class="fixed inset-0 z-[80] bg-black bg-opacity-95 hidden items-center justify-center flex-col">
        <div class="loader mb-4"></div>
        <h2 class="text-xl font-bold text-white mb-2">Subiendo a Google Drive...</h2>
        <p class="text-gray-400 text-sm">Por favor, no cierres la ventana.</p>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded shadow-lg z-[70] hidden transition-opacity">Mensaje</div>

<script>
/**
 * STREAMFLIX CORE ENGINE
 * V5.3.1 - EPG Data Decoding Fix
 */

// --- TU CLIENT ID DE GOOGLE CONFIGURADO ---
const GOOGLE_CLIENT_ID = '653955063422-dr882a448japajmpfs8l8pkbk50vi4dn.apps.googleusercontent.com'; 

const DOM = {
    login: document.getElementById('loginScreen'),
    main: document.getElementById('mainInterface'),
    gridSection: document.getElementById('gridSection'), // Nuevo
    grid: document.getElementById('gridContainer'),
    hero: document.getElementById('heroSection'),
    heroImg: document.getElementById('heroImage'),
    heroTitle: document.getElementById('heroTitle'),
    heroDesc: document.getElementById('heroDesc'),
    heroPlay: document.getElementById('heroPlayBtn'),
    search: document.getElementById('searchInput'),
    title: document.getElementById('sectionTitle'),
    liveToolbar: document.getElementById('liveToolbar'),
    catList: document.getElementById('categoryList'),
    layoutIcon: document.getElementById('layoutIcon'),
    layoutText: document.getElementById('layoutText'),
    overlay: document.getElementById('videoOverlay'),
    video: document.getElementById('mainVideo'),
    pTitle: document.getElementById('playerTitle'),
    pEpg: document.getElementById('playerEpg'),
    playBtn: document.getElementById('btnPlayPause'),
    progFill: document.getElementById('progressBarFill'),
    progCont: document.getElementById('progressBarContainer'),
    timeDisp: document.getElementById('timeDisplay'),
    volSlider: document.getElementById('volSlider'),
    muteBtn: document.getElementById('btnMute'),
    spinner: document.getElementById('bufferingSpinner'),
    btnRecord: document.getElementById('btnRecord'),
    recDot: document.getElementById('recDot'),
    recText: document.getElementById('recText'),
    detailModal: document.getElementById('detailModal'),
    detailContent: document.getElementById('detailContent'),
    settingsModal: document.getElementById('settingsModal'),
    folderStatus: document.getElementById('folderStatus'),
    driveStatus: document.getElementById('driveStatus'),
    uploadModal: document.getElementById('uploadProgressModal'),
    recIndicator: document.getElementById('recordingIndicator'),
    recBgTitle: document.getElementById('recBackgroundTitle'),
    // NUEVOS EPG
    epgSection: document.getElementById('epgSection'),
    epgList: document.getElementById('epgList')
};

const STATE = {
    data: { live: [], movie: [], series: [] },
    view: 'home',
    activeCat: 'Todas', 
    viewMode: 'grid', 
    favorites: JSON.parse(localStorage.getItem('sf_favorites')) || [],
    creds: null,
    sourceType: null,
    renderList: [],
    page: 1,
    perPage: 50,
    hls: null,
    driveToken: null,
    currentStreamName: '',
    epgData: {} // Para almacenar toda la EPG de los canales { channelId: { channel: {...}, listings: [...] } }
};

// --- GOOGLE DRIVE MODULE ---
const drive = {
    tokenClient: null,
    
    init: () => {
        if(typeof google === 'undefined') {
            console.warn("Librería de Google no cargada.");
            return;
        }
        
        try {
            drive.tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/drive.file',
                callback: (tokenResponse) => {
                    if (tokenResponse && tokenResponse.access_token) {
                        STATE.driveToken = tokenResponse.access_token;
                        DOM.driveStatus.innerHTML = `<i class="fas fa-check-circle mr-2 text-green-500"></i> Conectado`;
                        DOM.driveStatus.classList.replace('text-gray-500', 'text-white');
                        app.showToast("Google Drive Conectado");
                        localStorage.setItem('sf_drive_connected', 'true');
                    }
                },
            });
        } catch(e) {
            console.error("Error inicializando Google:", e);
        }
    },

    login: () => {
        if(!drive.tokenClient) {
             drive.init(); 
             if(!drive.tokenClient) {
                alert("Error inicializando Google Auth. Revisa la consola.");
                return;
             }
        }
        drive.tokenClient.requestAccessToken();
    },

    upload: async (blob, filename) => {
        if (!STATE.driveToken) {
            app.showToast("Error: Token Drive no válido. Descargando local...");
            recorder.downloadLocal(blob, filename);
            return;
        }

        DOM.uploadModal.classList.remove('hidden');
        DOM.uploadModal.classList.add('flex');

        const metadata = {
            name: filename,
            mimeType: 'video/webm'
        };

        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', blob);

        try {
            const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({ 'Authorization': 'Bearer ' + STATE.driveToken }),
                body: form
            });
            const data = await res.json();
            if(data.id) {
                app.showToast("¡Grabación guardada en Drive!");
            } else {
                throw new Error("Error API Drive");
            }
        } catch(e) {
            console.error(e);
            app.showToast("Fallo subida a Drive. Descargando local.");
            recorder.downloadLocal(blob, filename);
        } finally {
            DOM.uploadModal.classList.add('hidden');
            DOM.uploadModal.classList.remove('flex');
        }
    }
};

// --- RECORDER MODULE ---
const recorder = {
    isRecording: false,
    mediaRecorder: null,
    dirHandle: null,
    fileHandle: null,
    writable: null,
    chunks: [],

    pickFolder: async () => {
        try {
            recorder.dirHandle = await window.showDirectoryPicker();
            DOM.folderStatus.innerHTML = `<i class="fas fa-check-circle mr-2 text-green-500"></i> Carpeta: ${recorder.dirHandle.name}`;
            DOM.folderStatus.classList.replace('text-yellow-500', 'text-white');
            app.showToast(`Guardando en: ${recorder.dirHandle.name}`);
        } catch (err) { console.error(err); }
    },

    start: async (stream) => {
        recorder.chunks = [];
        const options = { mimeType: 'video/webm; codecs=vp9' };
        if (!MediaRecorder.isTypeSupported(options.mimeType)) options.mimeType = 'video/webm';
        recorder.mediaRecorder = new MediaRecorder(stream, options);
        if (recorder.dirHandle && !STATE.driveToken) { // Modo Stream a Disco Local
            try {
                const fileName = `streamflix_${Date.now()}.webm`;
                recorder.fileHandle = await recorder.dirHandle.getFileHandle(fileName, { create: true });
                recorder.writable = await recorder.fileHandle.createWritable();
                recorder.mediaRecorder.ondataavailable = async (event) => {
                    if (event.data.size > 0 && recorder.writable) await recorder.writable.write(event.data);
                };
                recorder.mediaRecorder.onstop = async () => {
                    if(recorder.writable) await recorder.writable.close();
                    app.showToast("Grabado en disco local.");
                    DOM.recIndicator.classList.add('hidden');
                };
            } catch(e) {
                console.error("Fallo local", e);
                recorder.dirHandle = null;
                recorder.startFallback(stream, options);
                return;
            }
        } else { // Modo Memoria (Drive o Descarga)
            recorder.mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) recorder.chunks.push(event.data);
            };
            recorder.mediaRecorder.onstop = () => {
                const blob = new Blob(recorder.chunks, { type: 'video/webm' });
                const fileName = `streamflix_cloud_${Date.now()}.webm`;
                if (STATE.driveToken) drive.upload(blob, fileName);
                else recorder.downloadLocal(blob, fileName);
                DOM.recIndicator.classList.add('hidden');
            };
        }

        recorder.mediaRecorder.start();
        recorder.isRecording = true;
        app.showToast("Grabación iniciada en 2º plano.");
    },

    stop: () => {
        if (recorder.isRecording) {
            recorder.mediaRecorder.stop();
            recorder.isRecording = false;
        }
    },

    downloadLocal: (blob, filename) => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        app.showToast("Grabación descargada localmente.");
    },
    
    // Fallback for browsers without stream to disk API
    startFallback: (stream, options) => { 
        recorder.chunks = [];
        recorder.mediaRecorder = new MediaRecorder(stream, options);
        recorder.mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) recorder.chunks.push(event.data);
        };
        recorder.mediaRecorder.onstop = () => {
            const blob = new Blob(recorder.chunks, { type: 'video/webm' });
            recorder.downloadLocal(blob, `grabacion_fallback_${Date.now()}.webm`);
            DOM.recIndicator.classList.add('hidden');
        };
        recorder.mediaRecorder.start();
        recorder.isRecording = true;
    }
};

// --- APP LOGIC ---
const app = {
    init: () => {
        document.getElementById('tabM3u').onclick = () => app.toggleLoginTab('m3u');
        document.getElementById('tabXtream').onclick = () => app.toggleLoginTab('xtream');

        const stored = localStorage.getItem('sf_creds');
        if (stored) {
            const data = JSON.parse(stored);
            if (data.type === 'm3u') {
                document.getElementById('m3uInput').value = data.url;
                app.loadSource('m3u', true);
            } else {
                document.getElementById('xServer').value = data.server;
                document.getElementById('xUser').value = data.username;
                document.getElementById('xPass').value = data.password;
                app.loadSource('xtream', true);
            }
        }

        window.onload = () => {
            setTimeout(() => drive.init(), 1000);
        };
        
        DOM.search.addEventListener('input', (e) => {
            if(e.target.value.length > 2) app.filterContent(e.target.value);
            else if(e.target.value.length === 0) app.nav(STATE.view);
        });

        document.getElementById('contentArea').addEventListener('scroll', (e) => {
            if (e.target.scrollHeight - e.target.scrollTop <= e.target.clientHeight + 200)
                app.renderMore();
        });

        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }, 1000);
    },

    toggleLoginTab: (tab) => {
        const m3uP = document.getElementById('panelM3u');
        const xtP = document.getElementById('panelXtream');
        const m3uT = document.getElementById('tabM3u');
        const xtT = document.getElementById('tabXtream');

        if (tab === 'm3u') {
            m3uP.classList.remove('hidden');
            xtP.classList.add('hidden');
            m3uT.classList.add('border-red-600', 'text-white');
            m3uT.classList.remove('text-gray-400');
            xtT.classList.remove('border-red-600', 'text-white');
            xtT.classList.add('text-gray-400');
        } else {
            xtP.classList.remove('hidden');
            m3uP.classList.add('hidden');
            xtT.classList.add('border-red-600', 'text-white');
            xtT.classList.remove('text-gray-400');
            m3uT.classList.remove('border-red-600', 'text-white');
            m3uT.classList.add('text-gray-400');
        }
    },

    loadSource: async (type, isAuto = false) => {
        const status = document.getElementById('loginStatus');
        status.className = "mt-4 text-sm text-center text-gray-400";
        status.innerText = "Cargando...";

        try {
            if (type === 'm3u') {
                const url = document.getElementById('m3uInput').value.trim();
                if (!url.startsWith('http')) throw new Error("URL M3U no válida.");
                
                const response = await fetch(url);
                const text = await response.text();
                app.parseM3U(text);
                
                localStorage.setItem('sf_creds', JSON.stringify({ type: 'm3u', url }));
                STATE.sourceType = 'm3u';
            } else if (type === 'xtream') {
                const s = document.getElementById('xServer').value.trim().replace(/\/+$/, '');
                const u = document.getElementById('xUser').value.trim();
                const p = document.getElementById('xPass').value.trim();

                if (!s || !u || !p) throw new Error("Todos los campos son obligatorios.");

                STATE.creds = { s, u, p };

                const [liveRes, vodRes, serRes, epgRes] = await Promise.all([
                    fetch(`https://miproxyiptv.onrender.com/${s}/player_api.php?username=${u}&password=${p}&action=get_live_streams`),
                    fetch(`https://miproxyiptv.onrender.com/${s}/player_api.php?username=${u}&password=${p}&action=get_vod_streams`),
                    fetch(`https://miproxyiptv.onrender.com/${s}/player_api.php?username=${u}&password=${p}&action=get_series`),
                    fetch(`https://miproxyiptv.onrender.com/${s}/xmltv.php?username=${u}&password=${p}`)
                ]);

                const [live, vod, ser, epgRaw] = await Promise.all([liveRes.json(), vodRes.json(), serRes.json(), epgRes.text()]);

                // LIVE
                STATE.data.live = live.map(x => ({ 
                    id: x.stream_id, 
                    name: x.name, 
                    img: x.stream_icon, 
                    url: `${s}/live/${u}/${p}/${x.stream_id}.m3u8`, 
                    type: 'live', 
                    cat: x.category_name 
                }));

                // MOVIES
                STATE.data.movie = vod.map(x => ({ 
                    id: x.vod_id, 
                    name: x.name, 
                    img: x.stream_icon, 
                    url: null, 
                    type: 'movie', 
                    cat: x.category_name 
                }));

                // SERIES
                STATE.data.series = ser.map(x => ({ 
                    id: x.series_id, 
                    name: x.name, 
                    img: x.cover || x.stream_icon, 
                    url: null, 
                    type: 'series', 
                    plot: x.plot 
                }));

                // EPG (XMLTV Parsing)
                app.parseXMLTV(epgRaw);

                localStorage.setItem('sf_creds', JSON.stringify({ type: 'xtream', server:s, username:u, password:p }));
                STATE.sourceType = 'xtream';
            }

            status.innerText = "¡Listo!";
            setTimeout(() => {
                DOM.login.classList.add('hidden');
                DOM.main.classList.remove('hidden');
                app.nav('home');
            }, 500);

        } catch (e) {
            console.error(e);
            status.innerText = "Error: " + e.message;
            status.className = "mt-4 text-sm text-center text-red-500";
        }
    },

    parseM3U: (text) => {
        const lines = text.split('\n');
        STATE.data = { live: [], movie: [], series: [] };

        for(let i=0; i<lines.length; i++) {
            const line = lines[i].trim();
            if(line.startsWith('#EXTINF:')) {
                const url = lines[i+1]?.trim();
                if(url && !url.startsWith('#')) {
                    const name = line.substring(line.lastIndexOf(',')+1).trim();
                    const img = line.match(/tvg-logo="([^"]*)"/)?.[1] || '';
                    const group = line.match(/group-title="([^"]*)"/)?.[1] || 'General';
                    const groupUpper = group.toUpperCase();

                    const isMovie = url.includes('/movie/') || groupUpper.includes('MOVIE') || url.match(/\.(mp4|mkv|avi)$/i);
                    const isSeries = url.includes('/series/') || groupUpper.includes('SERIES');
                    
                    if(isSeries) STATE.data.series.push({ name, img, url, type: 'series', group });
                    else if(isMovie) STATE.data.movie.push({ name, img, url, type: 'movie', group });
                    else STATE.data.live.push({ name, img, url, type: 'live', cat: group });
                }
            }
        }
    },

    clearData: () => {
        localStorage.clear();
        location.reload();
    },

    nav: (view) => {
        STATE.view = view;
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(`nav-${view}`).classList.add('active');
        DOM.gridSection.classList.add('hidden');
        DOM.liveToolbar.classList.add('hidden');
        DOM.hero.classList.add('hidden');
        DOM.epgSection.classList.add('hidden');

        DOM.grid.innerHTML = '';
        STATE.page = 1;
        DOM.search.value = '';

        if (view === 'live' || view === 'favorites') {
            DOM.gridSection.classList.remove('hidden');
            DOM.liveToolbar.classList.remove('hidden');
            DOM.title.innerText = view === 'live' ? 'Canales en Vivo' : 'Mis Favoritos';
            STATE.renderList = view === 'live' ? STATE.data.live : STATE.favorites.filter(f => f.type === 'live');
            app.renderCategories();
            app.filterByCategory(STATE.activeCat);
        } else if (view === 'home') {
            DOM.gridSection.classList.remove('hidden');
            DOM.title.innerText = 'Tendencias';
            STATE.renderList = [...STATE.data.live, ...STATE.data.movie, ...STATE.data.series].slice(0, 100);
            app.renderMore();
            if (STATE.renderList.length > 0) app.setHero(STATE.renderList[0]);
        } else if (view === 'epg') {
            DOM.epgSection.classList.remove('hidden');
            app.loadEPG();
        } else if (view === 'movies' || view === 'series') {
            DOM.gridSection.classList.remove('hidden');
            DOM.title.innerText = view === 'movies' ? "Películas" : "Series";
            STATE.renderList = STATE.data[view === 'movies' ? 'movie' : 'series'];
            app.renderMore();
        }
    },

    // ------------------------------------
    // NUEVA FUNCIÓN DE DECODIFICACIÓN SEGURA
    // ------------------------------------
    safeBase64Decode: (encoded) => {
        if (!encoded) return 'Programa sin título/descripción';
        try {
            // Intento de decodificación Base64 a UTF-8 (necesario para Xtream Codes)
            return decodeURIComponent(atob(encoded).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
        } catch (e) {
            // Si falla (por Base64 corrupto), devolvemos un marcador para evitar el error
            console.error("Fallo al decodificar Base64:", e, "Input:", encoded);
            return 'Título ilegible (Error de Decodificación)';
        }
    },
    // ------------------------------------
    // FIN NUEVA FUNCIÓN
    // ------------------------------------

    // NUEVO: Generar botones de hora (00:00 a 23:00)
    generateHourSelectors: (initialHour) => {
        const selector = document.getElementById('hourSelector');
        selector.innerHTML = '';
        const now = new Date();
        const currentHour = initialHour !== undefined ? initialHour : now.getHours();

        for (let i = 0; i < 24; i++) {
            const hour = i.toString().padStart(2, '0');
            const button = document.createElement('button');
            button.className = 'cat-chip flex-shrink-0';
            button.innerText = `${hour}:00`;
            button.dataset.hour = i;
            button.onclick = () => app.filterEPGByHour(i);

            if (i === currentHour) {
                button.classList.add('active');
            }
            selector.appendChild(button);
        }
        // Desplazar el selector para que se vea la hora actual
        const activeBtn = selector.querySelector('.active');
        if (activeBtn) {
            activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }
    },

    // NUEVO: Función para filtrar y renderizar EPG por hora
    filterEPGByHour: (hour) => {
        // Resaltar el botón activo
        document.getElementById('hourSelector').querySelectorAll('.cat-chip').forEach(btn => {
            btn.classList.toggle('active', parseInt(btn.dataset.hour) === hour);
        });

        DOM.epgList.innerHTML = '';
        const fragment = document.createDocumentFragment();
        const now = new Date();
        now.setHours(hour, 0, 0, 0); // Hora de inicio para el filtro

        // Filtrar y ordenar los canales que tienen al menos un programa en la hora seleccionada
        const channelsWithPrograms = Object.values(STATE.epgData)
            .filter(data => 
                data.listings.some(p => p.start.getHours() === hour || (p.start.getHours() < hour && p.end.getHours() >= hour))
            )
            .sort((a, b) => a.channel.name.localeCompare(b.channel.name));

        channelsWithPrograms.forEach(data => {
            const item = document.createElement('div');
            item.className = 'list-item flex-col md:flex-row items-start md:items-center list-item-epg bg-gray-900/70 border-gray-700/50 hover:bg-gray-800';
            
            // Programas que están activos o empiezan en esta hora
            const matchingPrograms = data.listings.filter(p => {
                return (p.start.getHours() === hour || (p.start.getHours() < hour && p.end.getHours() > hour));
            }).sort((a, b) => a.start - b.start);

            if (matchingPrograms.length === 0) return; // No debería pasar si el canal pasó el filtro principal

            const logo = data.channel.img.length > 5 ? data.channel.img : 'https://via.placeholder.com/100?text=TV';

            item.innerHTML = `
                <div class="flex-shrink-0 mb-3 md:mb-0 mr-4 flex items-center w-full md:w-auto">
                    <img src="${logo}" class="w-12 h-12 object-contain rounded mr-3" onerror="this.src='https://via.placeholder.com/100?text=TV'">
                    <div class="flex-grow">
                        <div class="font-bold text-white text-lg">${data.channel.name}</div>
                        <div class="text-sm text-gray-400">${data.channel.cat || 'General'}</div>
                    </div>
                </div>
                <div class="flex-grow grid grid-cols-1 md:grid-cols-3 gap-2 border-l-0 md:border-l border-gray-600 md:pl-4">
                    ${matchingPrograms.slice(0, 3).map(p => `
                        <div class="p-2 rounded-md bg-gray-700/50 hover:bg-gray-700 transition cursor-pointer" onclick="player.start('${data.channel.url}', '${data.channel.name} - ${p.title.replace(/'/g, "\\'")}', 'live', '${data.channel.id}')" title="${p.title}: ${p.desc}">
                            <span class="text-xs font-medium text-red-400">${p.start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} - ${p.end.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                            <div class="text-white text-sm font-bold truncate">${p.title}</div>
                        </div>
                    `).join('')}
                    ${matchingPrograms.length > 3 ? `<div class="text-center text-gray-500 text-sm flex items-center justify-center">... ${matchingPrograms.length - 3} programas más</div>` : ''}
                </div>
                <div class="flex-shrink-0 ml-4 hidden md:flex">
                    <button onclick="player.start('${data.channel.url}', '${data.channel.name}', 'live', '${data.channel.id}')" class="bg-red-600 hover:bg-red-700 text-white p-3 rounded-full"><i class="fas fa-play"></i></button>
                </div>
            `;
            fragment.appendChild(item);
        });

        if (channelsWithPrograms.length === 0) {
            DOM.epgList.innerHTML = `<p class="text-gray-400 p-4 text-center">No hay programas para la hora ${hour.toString().padStart(2, '0')}:00.</p>`;
        } else {
            DOM.epgList.appendChild(fragment);
        }
    },

    // NUEVO: Parser XMLTV (Formato EPG Xtream Codes)
    parseXMLTV: (xmlText) => {
        STATE.epgData = {};
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, "text/xml");

        // 1. Obtener información de canales
        xmlDoc.querySelectorAll('channel').forEach(channelEl => {
            const id = channelEl.getAttribute('id');
            const name = channelEl.querySelector('display-name')?.textContent || 'Sin Nombre';
            const icon = channelEl.querySelector('icon')?.getAttribute('src') || '';
            const matchingChannel = STATE.data.live.find(c => c.id == id);
            
            if (matchingChannel) {
                STATE.epgData[id] = {
                    channel: {
                        id: id,
                        name: name,
                        img: icon || matchingChannel.img,
                        url: matchingChannel.url,
                        cat: matchingChannel.cat
                    },
                    listings: []
                };
            }
        });

        // 2. Obtener listings (programación)
        xmlDoc.querySelectorAll('programme').forEach(progEl => {
            const id = progEl.getAttribute('channel');
            if (STATE.epgData[id]) {
                const startStr = progEl.getAttribute('start');
                const endStr = progEl.getAttribute('stop');

                // Función auxiliar para parsear el formato YYYYMMDDHHMMSS ±ZONE
                const parseDate = (str) => {
                    if (!str || str.length < 14) return null;
                    const year = str.substring(0, 4);
                    const month = str.substring(4, 6);
                    const day = str.substring(6, 8);
                    const hour = str.substring(8, 10);
                    const minute = str.substring(10, 12);
                    const second = str.substring(12, 14);
                    const tz = str.substring(14);
                    
                    // Simple T-Z format for Date object
                    return new Date(`${year}-${month}-${day}T${hour}:${minute}:${second}${tz}`);
                };

                const titleEl = progEl.querySelector('title');
                const descEl = progEl.querySelector('desc');
                
                // Aplicar decodificación segura al título/descripción
                const title = titleEl ? app.safeBase64Decode(titleEl.textContent) : 'Sin Título';
                const desc = descEl ? app.safeBase64Decode(descEl.textContent) : 'Sin Descripción';


                STATE.epgData[id].listings.push({
                    start: parseDate(startStr),
                    end: parseDate(endStr),
                    title: title,
                    desc: desc
                });
            }
        });
    },

    // NUEVO: Cargar EPG
    loadEPG: async () => {
        DOM.epgList.innerHTML = '<p class="text-gray-400 p-4 text-center"><i class="fas fa-sync-alt fa-spin mr-2"></i> Cargando Guía EPG...</p>';
        app.generateHourSelectors();
        
        if (STATE.sourceType !== 'xtream') {
            DOM.epgList.innerHTML = '<p class="text-yellow-400 mb-4 bg-yellow-900/50 p-3 rounded"><i class="fas fa-exclamation-triangle mr-2"></i> La guía EPG solo está disponible al cargar la lista con **Xtream Codes**.</p>';
            return;
        }

        // Si ya hay datos de EPG, solo renderizar
        const totalPrograms = Object.values(STATE.epgData).reduce((acc, data) => acc + data.listings.length, 0);
        if (totalPrograms > 0) {
            const now = new Date().getHours();
            app.filterEPGByHour(now);
            return;
        }
        
        // Si no hay EPG (aunque se llamó a parseXMLTV al inicio), mostramos el mensaje de error de Xtream.
        DOM.epgList.innerHTML = '<p class="text-yellow-400 mb-4 bg-yellow-900/50 p-3 rounded"><i class="fas fa-exclamation-triangle mr-2"></i>El servidor Xtream no devolvió ninguna programación EPG (Guía) para los canales solicitados. Puede que no esté disponible o la lista de canales no tenga metadatos EPG.</p>';
    },
    // FIN MODIFICACIÓN EPG


    renderCategories: () => {
        const uniqueCats = ['Todas', ...new Set(STATE.data.live.map(c => c.cat))].sort();
        DOM.catList.innerHTML = uniqueCats.map(cat => `<button onclick="app.setCategory('${cat}')" class="cat-chip ${STATE.activeCat === cat ? 'active' : ''}">${cat}</button>`).join('');
    },

    setCategory: (cat) => {
        STATE.activeCat = cat;
        app.renderCategories();
        app.filterByCategory(cat);
    },

    filterByCategory: (cat) => {
        STATE.page = 1;
        DOM.grid.innerHTML = '';
        STATE.renderList = cat === 'Todas' ? STATE.data.live : STATE.data.live.filter(c => c.cat === cat);
        app.renderMore();
    },

    toggleLayout: () => {
        STATE.viewMode = STATE.viewMode === 'grid' ? 'list' : 'grid';
        DOM.layoutText.innerText = STATE.viewMode === 'grid' ? 'Grid' : 'Lista';
        DOM.layoutIcon.className = STATE.viewMode === 'grid' ? 'fas fa-th-large mr-2' : 'fas fa-list mr-2';
        DOM.grid.innerHTML = '';
        STATE.page = 1;
        if(STATE.viewMode === 'list') DOM.grid.classList.add('list-layout');
        else DOM.grid.classList.remove('list-layout');
        app.renderMore();
    },

    filterContent: (term) => {
        term = term.toLowerCase();
        let pool = [...STATE.data.live, ...STATE.data.movie, ...STATE.data.series];
        
        if(STATE.view !== 'home' && STATE.view !== 'favorites') pool = STATE.data[STATE.view === 'movies' ? 'movie' : 'series'];
        if(STATE.view === 'live') pool = STATE.data.live;
        if(STATE.view === 'favorites') pool = STATE.favorites;

        STATE.page = 1;
        DOM.grid.innerHTML = '';
        STATE.renderList = pool.filter(item => item.name.toLowerCase().includes(term));
        app.renderMore();
    },

    renderMore: () => {
        const start = (STATE.page - 1) * STATE.perPage;
        const end = start + STATE.perPage;
        const itemsToRender = STATE.renderList.slice(start, end);

        if (itemsToRender.length === 0 && STATE.page > 1) return; 

        if (itemsToRender.length === 0) {
            DOM.grid.innerHTML = `<p class="p-6 text-gray-400">No hay contenido disponible para la vista actual.</p>`;
            return;
        }

        const fragment = document.createDocumentFragment();
        
        const isList = STATE.viewMode === 'list' && (STATE.view === 'live' || STATE.view === 'favorites');
        const placeholder = 'https://via.placeholder.com/100x150/222/FFF?text=No+Logo';

        itemsToRender.forEach(item => {
            const el = document.createElement('div');
            const isFav = STATE.favorites.some(f => f.name === item.name);
            const imgUrl = item.img || placeholder;
            const hasImg = item.img && item.img.length > 5;

            if (isList) {
                el.className = 'list-item group animate-fade-in';
                el.innerHTML = `
                    <img src="${hasImg ? imgUrl : placeholder}" loading="lazy" onerror="this.src='${placeholder}'">
                    <div class="flex-grow"><div class="font-bold text-white text-sm md:text-base">${item.name}</div><div class="text-xs text-gray-400">${item.cat || ''}</div></div>
                    <div class="flex items-center space-x-3 mr-2">
                        <button class="text-gray-400 hover:text-red-500 fav-trigger"><i class="${isFav ? 'fas' : 'far'} fa-heart"></i></button>
                        <button class="bg-red-600 text-white p-2 rounded-full hover:bg-red-700 play-trigger"><i class="fas fa-play"></i></button>
                    </div>`;
            } else {
                el.className = 'poster-card group';
                const objFitClass = item.type === 'live' ? 'object-contain p-2' : 'object-cover';
                el.innerHTML = `
                    <div class="poster-fallback"><span>${item.name}</span></div>
                    ${hasImg ? `<img src="${imgUrl}" loading="lazy" class="poster-img ${objFitClass}" onerror="this.classList.add('img-error')">` : ''}
                    <div class="poster-overlay">
                        <h4 class="font-bold text-white text-sm leading-tight mb-2 line-clamp-2">${item.name}</h4>
                        <div class="flex justify-between items-center">
                            <button class="bg-white text-black rounded-full w-8 h-8 flex items-center justify-center hover:scale-110 transition play-trigger"><i class="fas fa-play text-xs"></i></button>
                            <button class="text-white hover:text-red-500 transition fav-trigger"><i class="${isFav ? 'fas' : 'far'} fa-heart"></i></button>
                        </div>
                    </div>`;
            }

            const action = (e) => {
                if(e) e.stopPropagation();
                if(item.type === 'live') player.start(item.url, item.name, item.type, item.id);
                else app.openDetail(item);
            };

            el.querySelector('.play-trigger').onclick = action;
            el.onclick = action;

            el.querySelector('.fav-trigger').onclick = (e) => {
                e.stopPropagation();
                app.toggleFav(item, e.currentTarget.querySelector('i'));
            };

            fragment.appendChild(el);
        });

        DOM.grid.appendChild(fragment);
        STATE.page++;
    },

    toggleFav: (item, icon) => {
        const idx = STATE.favorites.findIndex(f => f.name === item.name);
        if (idx > -1) {
            STATE.favorites.splice(idx, 1);
            icon.classList.replace('fas', 'far');
            icon.parentElement.classList.remove('text-red-500');
            app.showToast('Eliminado de Favoritos');
        } else {
            STATE.favorites.push(item);
            icon.classList.replace('far', 'fas');
            icon.parentElement.classList.add('text-red-500');
            app.showToast('Añadido a Favoritos');
        }
        localStorage.setItem('sf_favorites', JSON.stringify(STATE.favorites));
        if (STATE.view === 'favorites') app.nav('favorites');
    },

    setHero: (item) => {
        if (!item) {
            DOM.hero.classList.add('hidden');
            return;
        }
        const img = item.img || 'https://assets.nflxext.com/ffe/siteui/vlv3/f841d4c7-10e1-40af-bcae-07a3f8dc141a/f6d7434e-d6de-4185-a6d4-c77a2d08737b/US-en-20220502-popsignuptwoweeks-perspective_alpha_website_medium.jpg';
        DOM.heroImg.src = img;
        DOM.heroTitle.innerText = item.name;
        DOM.heroDesc.innerText = item.plot || "Disfruta de la mejor televisión, películas y series en alta definición.";
        DOM.heroPlay.onclick = () => {
            if (item.type === 'live') player.start(item.url, item.name, item.type, item.id);
            else app.openDetail(item);
        };
        DOM.hero.classList.remove('hidden');
    },

    openSettings: () => {
        DOM.settingsModal.classList.remove('hidden');
        DOM.settingsModal.classList.add('flex');
    },

    closeSettings: () => {
        DOM.settingsModal.classList.add('hidden');
        DOM.settingsModal.classList.remove('flex');
    },

    showToast: (message) => {
        const toast = document.getElementById('toast');
        toast.innerText = message;
        toast.classList.remove('hidden');
        toast.style.opacity = 1;
        setTimeout(() => {
            toast.style.opacity = 0;
            setTimeout(() => toast.classList.add('hidden'), 500);
        }, 3000);
    },

    // Traduce un texto (simulado o no, dependiendo del proxy)
    translate: async (text) => {
        // En una implementación real, aquí se llamaría a una API de traducción. 
        // Por ahora, se devuelve el mismo texto.
        return text; 
    },

    openDetail: async (item) => {
        DOM.detailModal.classList.remove('hidden');
        DOM.detailModal.classList.add('flex');
        DOM.detailContent.innerHTML = '<div class="p-10 w-full text-center"><div class="loader mx-auto mb-4"></div><p class="text-gray-400">Cargando detalles...</p></div>';

        try {
            const { s, u, p } = STATE.creds || {};
            let htmlContent = '';

            if (STATE.sourceType === 'xtream') {
                if (item.type === 'series') {
                    const info = await (await fetch(`https://miproxyiptv.onrender.com/${s}/player_api.php?username=${u}&password=${p}&action=get_series_info&series_id=${item.id}`)).json();
                    
                    let episodesHtml = '';
                    const seasons = Object.values(info.episodes || {});
                    seasons.sort((a, b) => parseInt(a[0].season_num) - parseInt(b[0].season_num));
                    
                    seasons.forEach(seasonEpisodes => {
                        const seasonNum = seasonEpisodes[0].season_num;
                        episodesHtml += `<h4 class="text-xl font-bold text-white mt-6 mb-3 border-b border-gray-700 pb-1">Temporada ${seasonNum}</h4><div class="space-y-2">`;
                        seasonEpisodes.forEach(ep => {
                            const playUrl = `${s}/series/${u}/${p}/${ep.id}.${ep.container_extension}`;
                            episodesHtml += `<div onclick="player.start('${playUrl}', 'S${seasonNum}E${ep.episode_num} - ${ep.title.replace(/'/g, "\\'")}', 'series')" class="list-item group cursor-pointer hover:bg-gray-700/50 p-3 rounded flex items-center"><span class="text-gray-400 mr-4 font-mono">${ep.episode_num}</span><div class="flex-grow"><div class="font-medium group-hover:text-white text-gray-300">${ep.title}</div></div><i class="fas fa-play-circle text-2xl text-transparent group-hover:text-red-600"></i></div>`;
                        });
                        episodesHtml += `</div>`;
                    });

                    const plot = await app.translate(info.info.plot || "Sin sinopsis.");
                    htmlContent = app.buildDetailHtml(info.info.cover || item.img, info.info.name, plot, episodesHtml, null);

                } else {
                    const info = await (await fetch(`https://miproxyiptv.onrender.com/${s}/player_api.php?username=${u}&password=${p}&action=get_vod_info&vod_id=${item.id}`)).json();
                    const plot = await app.translate(info.info.plot || "Sin descripción.");
                    htmlContent = app.buildDetailHtml(info.info.movie_image, info.info.name, plot, '', `${s}/movie/${u}/${p}/${info.movie_data.stream_id}.${info.movie_data.container_extension}`);
                }
            } else {
                htmlContent = app.buildDetailHtml(item.img, item.name, "Info no disponible en M3U.", '', item.url);
            }

            DOM.detailContent.innerHTML = htmlContent;

        } catch (e) {
            DOM.detailContent.innerHTML = '<div class="p-10 w-full text-center text-red-500">Error cargando detalles.</div>';
        }
    },

    buildDetailHtml: (img, title, desc, extraHtml, playUrl) => {
        const posterImg = img || 'https://via.placeholder.com/300x450/222/FFF?text=No+Poster';
        const playBtnHtml = playUrl ? `<button onclick="player.start('${playUrl}', '${title.replace(/'/g, "\\'")}', 'movie')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded flex items-center transition transform hover:scale-105"><i class="fas fa-play mr-3"></i> REPRODUCIR</button>` : '';

        return `<div class="md:w-1/3 h-64 md:h-full relative flex-shrink-0"><img src="${posterImg}" class="w-full h-full object-cover"><div class="absolute inset-0 bg-gradient-to-t from-[#181818] to-transparent md:bg-gradient-to-r"></div></div><div class="flex-1 p-6 md:p-8 overflow-y-auto"><h2 class="text-3xl font-bold mb-3 text-white">${title}</h2><p class="text-gray-400 mb-6">${desc}</p>${playBtnHtml}<div id="detailExtraContent">${extraHtml}</div></div>`;
    }
};

// --- VIDEO PLAYER MODULE ---
const player = {
    url: null,
    title: null,
    type: null,
    channelId: null,

    start: (url, title, type, channelId = null) => {
        player.url = url;
        player.title = title;
        player.type = type;
        player.channelId = channelId;

        // Reset HLS
        if (STATE.hls) {
            STATE.hls.destroy();
            STATE.hls = null;
        }
        
        // Cierra el modal de detalles si está abierto
        if (!DOM.detailModal.classList.contains('hidden')) app.closeDetail();

        DOM.overlay.classList.remove('hidden');
        DOM.pTitle.innerText = title;
        DOM.btnRecord.classList.add('hidden'); // Ocultar por defecto

        if (Hls.isSupported() && url.endsWith('.m3u8')) {
            STATE.hls = new Hls();
            STATE.hls.loadSource(url);
            STATE.hls.attachMedia(DOM.video);
        } else if (DOM.video.canPlayType('application/vnd.apple.mpegurl')) {
            DOM.video.src = url;
        } else {
            DOM.video.src = url;
        }
        
        DOM.video.volume = DOM.volSlider.value;
        DOM.video.play().catch(e => console.error("Error al reproducir el video:", e));
        
        // Mostrar botón de grabación solo para canales LIVE
        if (type === 'live' && window.MediaRecorder && (window.showDirectoryPicker || STATE.driveToken)) {
             DOM.btnRecord.classList.remove('hidden');
        }

        // Obtener EPG actual si es LIVE y Xtream
        if(STATE.sourceType === 'xtream' && type === 'live' && channelId) {
            const { s, u, p } = STATE.creds;
            const id = channelId;
            // Llamar al endpoint para obtener el EPG completo (usando get_short_epg)
            fetch(`https://miproxyiptv.onrender.com/${STATE.creds.s}/player_api.php?username=${STATE.creds.u}&password=${STATE.creds.p}&action=get_short_epg&stream_id=${id}`)
                .then(r=>r.json()).then(d => {
                    DOM.pEpg.innerText = d.epg_listings && d.epg_listings.length ? `AHORA: ${app.safeBase64Decode(d.epg_listings[0].title)}` : "Sin EPG";
                }).catch(()=>DOM.pEpg.innerText = "");
        }
    },

    togglePlay: () => {
        if (DOM.video.paused) {
            DOM.video.play();
            DOM.playBtn.innerHTML = '<i class="fas fa-pause"></i>';
            DOM.overlay.classList.remove('active-ui');
            document.getElementById('centerPlayIcon').classList.remove('opacity-100');
        } else {
            DOM.video.pause();
            DOM.playBtn.innerHTML = '<i class="fas fa-play"></i>';
            DOM.overlay.classList.add('active-ui');
            document.getElementById('centerPlayIcon').classList.add('opacity-100');
            setTimeout(() => document.getElementById('centerPlayIcon').classList.remove('opacity-100'), 500);
        }
    },

    toggleFullscreen: () => {
        if (!document.fullscreenElement) {
            DOM.overlay.requestFullscreen();
        } else {
            document.exitFullscreen();
        }
    },
    
    rewind: () => { DOM.video.currentTime -= 10; },
    forward: () => { DOM.video.currentTime += 10; },

    toggleRecording: () => {
        if(recorder.isRecording) {
            recorder.stop();
            DOM.recDot.classList.remove('bg-red-600', 'animate-pulse');
            DOM.recDot.classList.add('bg-gray-400');
            DOM.recText.innerText = 'Grabar';
            DOM.btnRecord.classList.remove('border-red-600');
            app.showToast("Grabación Finalizada. Procesando...");
        } else {
            STATE.currentStreamName = player.title;
            const stream = DOM.video.captureStream();
            recorder.start(stream);
            DOM.recDot.classList.add('bg-red-600', 'animate-pulse');
            DOM.recDot.classList.remove('bg-gray-400');
            DOM.recText.innerText = 'Grabando...';
            DOM.btnRecord.classList.add('border-red-600');
        }
    },

    close: () => {
        if(recorder.isRecording) {
            DOM.overlay.classList.add('hidden');
            DOM.recBgTitle.innerText = STATE.currentStreamName;
            DOM.recIndicator.classList.remove('hidden');
            app.showToast("Grabación continuando en 2º plano");
        } else {
            DOM.video.pause();
            DOM.video.src = '';
            if(STATE.hls) STATE.hls.destroy();
            DOM.overlay.classList.add('hidden');
        }
    },

    restore: () => {
        DOM.overlay.classList.remove('hidden');
        DOM.recIndicator.classList.add('hidden');
    },

    stopBackground: () => {
        recorder.stop();
        DOM.video.pause();
        DOM.video.src = '';
        if(STATE.hls) STATE.hls.destroy();
        DOM.recIndicator.classList.add('hidden');
        DOM.overlay.classList.add('hidden');
    }
};

// --- EVENT LISTENERS & INIT ---
app.init();

// Player UI Listeners
DOM.video.addEventListener('timeupdate', () => {
    const time = DOM.video.currentTime;
    const duration = DOM.video.duration || 0;
    const minutes = Math.floor(time / 60);
    const seconds = Math.floor(time % 60);
    const totalMinutes = Math.floor(duration / 60);
    const totalSeconds = Math.floor(duration % 60);

    const timeString = duration ? 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')} / ${totalMinutes.toString().padStart(2, '0')}:${totalSeconds.toString().padStart(2, '0')}` :
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    DOM.timeDisp.innerText = timeString;
    if (duration) {
        DOM.progFill.style.width = `${(time / duration) * 100}%`;
    }
    
    // Auto-pause if live stream and duration is available (VOD/Series)
    if (duration > 0 && time >= duration && !DOM.video.paused) {
        DOM.video.pause();
        DOM.playBtn.innerHTML = '<i class="fas fa-play"></i>';
    }
});

DOM.video.addEventListener('loadedmetadata', () => {
    // Para streams en vivo donde la duración es Infinity/NaN
    if (DOM.video.duration === Infinity || isNaN(DOM.video.duration)) {
        DOM.timeDisp.innerText = "LIVE";
        DOM.progCont.classList.add('hidden');
    } else {
        DOM.progCont.classList.remove('hidden');
    }
});

DOM.video.addEventListener('play', () => DOM.playBtn.innerHTML = '<i class="fas fa-pause"></i>');
DOM.video.addEventListener('pause', () => DOM.playBtn.innerHTML = '<i class="fas fa-play"></i>');
DOM.video.addEventListener('seeking', () => DOM.spinner.classList.remove('hidden'));
DOM.video.addEventListener('seeked', () => DOM.spinner.classList.add('hidden'));
DOM.video.addEventListener('waiting', () => DOM.spinner.classList.remove('hidden'));
DOM.video.addEventListener('playing', () => DOM.spinner.classList.add('hidden'));
DOM.playBtn.addEventListener('click', player.togglePlay);
DOM.video.addEventListener('click', player.togglePlay);
DOM.progCont.addEventListener('click', (e) => { 
    if (DOM.video.duration && !isNaN(DOM.video.duration)) {
        const rect = DOM.progCont.getBoundingClientRect(); 
        DOM.video.currentTime = ((e.clientX - rect.left) / rect.width) * DOM.video.duration; 
    }
});
DOM.volSlider.addEventListener('input', (e) => { 
    DOM.video.volume = e.target.value; 
    DOM.muteBtn.innerHTML = e.target.value == 0 ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>'; 
});
DOM.muteBtn.addEventListener('click', () => { 
    DOM.video.muted = !DOM.video.muted; 
    DOM.muteBtn.innerHTML = DOM.video.muted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>'; 
});

let uiTimer;
const resetUITimer = () => { 
    DOM.overlay.classList.add('active-ui'); 
    DOM.overlay.style.cursor = 'default'; 
    clearTimeout(uiTimer); 
    uiTimer = setTimeout(() => { 
        if(!DOM.video.paused) { 
            DOM.overlay.classList.remove('active-ui'); 
            DOM.overlay.style.cursor = 'none'; 
        } 
    }, 5000); 
};
DOM.overlay.addEventListener('mousemove', resetUITimer); 
DOM.overlay.addEventListener('click', (e) => {
    if (e.target.id === 'videoOverlay') resetUITimer();
});

</script>
</body>
</html>