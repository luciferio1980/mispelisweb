<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor IPTV Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        :root { --main-bg: #0d1117; --container-bg: #161b22; --border-color: #30363d; --text-color: #c9d1d9; --accent-color: #58a6ff; }
        body { font-family: 'Inter', sans-serif; background-color: var(--main-bg); color: var(--text-color); display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 1rem; }
        .container { background-color: var(--container-bg); border: 1px solid var(--border-color); box-shadow: 0 4px 20px rgba(0,0,0,0.5); border-radius: 0.5rem; width: 100%; max-width: 900px; display: flex; flex-direction: column; overflow: hidden; }
        .player-container { position: relative; width: 100%; padding-top: 56.25%; background: black; }
        .player-container video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .controls { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.5); color: white; padding: 0.5rem; transition: opacity 0.3s; opacity: 0; }
        .player-container:hover .controls { opacity: 1; }
        .progress-bar-container { width: 100%; height: 0.5rem; background: rgba(255,255,255,0.3); border-radius: 0.25rem; overflow: hidden; cursor: pointer; }
        .progress-bar { height: 100%; background: var(--accent-color); width: 0; transition: width 0.1s linear; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; transition: opacity 0.3s, visibility 0.3s; opacity: 0; visibility: hidden; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--container-bg); padding: 1.5rem; border-radius: 0.5rem; max-height: 80vh; max-width: 90%; width: 500px; position: relative; transform: scale(0.95); transition: transform 0.3s; }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .content-list-modal-content { width: 90%; max-width: 800px; max-height: 90vh; }
        .search-container { position: sticky; top: -1.5rem; z-index: 10; padding: 1.5rem 0 0.5rem; margin: -1.5rem; background-color: var(--container-bg); border-bottom: 1px solid var(--border-color); }
        .list-items-container { max-height: calc(90vh - 120px); overflow-y: auto; padding-top: 0.5rem; }
        .list-item { display: flex; align-items: center; cursor: pointer; padding: 0.5rem; border-radius: 0.25rem; transition: background-color 0.2s; }
        .list-item:hover { background-color: var(--border-color); }
        .list-item img { width: 50px; height: 50px; object-fit: cover; border-radius: 0.25rem; margin-right: 0.75rem; }
        .list-item .info { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .list-item .info span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .loading-bar { width: 100%; height: 0.5rem; background-color: #4b5563; border-radius: 9999px; overflow: hidden; }
        .loading-fill { height: 100%; background-color: var(--accent-color); transition: width 0.3s ease-in-out; }
        .alert-message { position: fixed; top: 1rem; right: 1rem; background-color: #ef4444; color: white; padding: 0.75rem 1rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 2000; opacity: 0; transform: translateY(-20px); transition: opacity 0.3s, transform 0.3s; }
        .alert-message.show { opacity: 1; transform: translateY(0); }
        .tab-button.active { background-color: var(--border-color); }
        .hidden { display: none; }
        .accordion-item { border-bottom: 1px solid var(--border-color); }
        .accordion-button { width: 100%; text-align: left; padding: 0.75rem 0; cursor: pointer; }
        .accordion-button:hover { background-color: var(--border-color); }
        .accordion-button.active .fa-chevron-down { transform: rotate(180deg); }
        .accordion-collapse { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .accordion-collapse.show { max-height: 500px; /* Adjust as needed */ }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex justify-center items-center min-h-screen">
    <div class="container bg-gray-800 p-6 rounded-lg shadow-lg max-w-lg mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-center text-white">Reproductor IPTV Pro</h1>
        <div id="player-view" class="relative bg-black rounded-md mb-6 hidden">
            <div id="video-container" class="relative w-full aspect-video">
                <video id="player" class="absolute inset-0 w-full h-full" controls autoplay></video>
                <div id="video-info" class="absolute top-2 left-2 text-white bg-black bg-opacity-50 p-2 rounded-md font-bold"></div>
            </div>
            <div id="player-controls" class="absolute bottom-0 left-0 right-0 p-2 text-white bg-black bg-opacity-50 flex items-center gap-2 hidden">
                <span id="currentTime">00:00</span>
                <div id="progressBarContainer" class="flex-grow h-2 bg-gray-500 rounded-full cursor-pointer">
                    <div id="progressBar" class="h-full bg-blue-500 rounded-full" style="width: 0%;"></div>
                </div>
                <span id="duration">00:00</span>
                <i id="fullscreenBtn" class="fas fa-expand cursor-pointer text-lg"></i>
            </div>
            <div id="player-overlay" class="absolute inset-0 bg-black opacity-0 transition-opacity"></div>
        </div>
        <div id="main-menu" class="space-y-4">
            <div class="relative">
                <select id="loadMethod" class="w-full p-3 rounded-md bg-gray-700 text-gray-200 border border-gray-600 focus:outline-none focus:ring focus:ring-blue-500">
                    <option value="">Selecciona un método de carga</option>
                    <option value="m3u">Cargar URL M3U</option>
                    <option value="xtream">Cargar credenciales Xtream</option>
                </select>
                <i class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
            </div>
            <div id="m3uInput" class="space-y-4 hidden">
                <input type="text" id="m3uUrl" placeholder="Introduce la URL de tu lista M3U" class="w-full p-3 rounded-md bg-gray-700 text-gray-200 border border-gray-600 focus:outline-none focus:ring focus:ring-blue-500">
                <div class="loading-bar hidden" id="m3uProgress">
                    <div class="loading-fill" id="m3uProgressBarFill" style="width:0;"></div>
                </div>
                <p id="m3uProgressText" class="text-sm text-center text-gray-400"></p>
                <button id="loadM3uBtn" class="w-full p-3 bg-blue-600 text-white rounded-md font-bold hover:bg-blue-700 transition">Cargar lista M3U</button>
            </div>
            <div id="xtreamInputs" class="space-y-4 hidden">
                <input type="text" id="xtremioServer" placeholder="URL del servidor (ej: http://server.com:80)" class="w-full p-3 rounded-md bg-gray-700 text-gray-200 border border-gray-600 focus:outline-none focus:ring focus:ring-blue-500">
                <input type="text" id="xtremioUsername" placeholder="Usuario" class="w-full p-3 rounded-md bg-gray-700 text-gray-200 border border-gray-600 focus:outline-none focus:ring focus:ring-blue-500">
                <input type="password" id="xtremioPassword" placeholder="Contraseña" class="w-full p-3 rounded-md bg-gray-700 text-gray-200 border border-gray-600 focus:outline-none focus:ring focus:ring-blue-500">
                <div class="loading-bar hidden" id="xtremioProgress">
                    <div class="loading-fill" id="xtremioProgressBarFill" style="width:0;"></div>
                </div>
                <p id="xtremioProgressText" class="text-sm text-center text-gray-400"></p>
                <button id="loadXtremioBtn" class="w-full p-3 bg-blue-600 text-white rounded-md font-bold hover:bg-blue-700 transition">Cargar credenciales</button>
            </div>
            <div id="loaded-content-menu" class="space-y-4 hidden">
                <h2 class="text-2xl font-bold mb-2 text-center text-white">Contenido Cargado</h2>
                <button id="showLiveTvBtn" class="w-full p-3 bg-gray-700 text-gray-200 rounded-md hover:bg-gray-600 transition">Canales en Vivo</button>
                <button id="showMoviesBtn" class="w-full p-3 bg-gray-700 text-gray-200 rounded-md hover:bg-gray-600 transition">Películas</button>
                <button id="showSeriesBtn" class="w-full p-3 bg-gray-700 text-gray-200 rounded-md hover:bg-gray-600 transition">Series</button>
                <button id="settingsBtn" class="w-full p-3 bg-gray-700 text-gray-200 rounded-md hover:bg-gray-600 transition">Configuración</button>
            </div>
        </div>

        <div id="settingsModal" class="modal-overlay">
            <div class="modal-content">
                <h2 class="text-xl font-bold mb-4">Configuración</h2>
                <p class="mb-4">Borra tus credenciales guardadas. Deberás volver a introducirlas en el futuro.</p>
                <button id="clearCredentialsBtn" class="w-full p-3 bg-red-600 text-white rounded-md font-bold hover:bg-red-700 transition">Borrar credenciales</button>
                <button class="w-full p-3 mt-4 bg-gray-600 text-white rounded-md font-bold hover:bg-gray-700 transition close-modal">Cerrar</button>
            </div>
        </div>
        <div id="contentListModal" class="modal-overlay">
            <div class="modal-content content-list-modal-content">
                <div class="search-container">
                    <input type="text" id="searchBar" placeholder="Buscar..." class="w-full p-3 rounded-md bg-gray-700 text-gray-200 border border-gray-600 focus:outline-none focus:ring focus:ring-blue-500">
                </div>
                <div class="list-items-container" id="listItemsContainer"></div>
                <button class="w-full p-3 mt-4 bg-gray-600 text-white rounded-md font-bold hover:bg-gray-700 transition close-modal">Cerrar</button>
            </div>
        </div>
        <div id="seriesDetailModal" class="modal-overlay">
            <div class="modal-content">
                <div id="seriesDetailContent"></div>
                <button class="w-full p-3 mt-4 bg-gray-600 text-white rounded-md font-bold hover:bg-gray-700 transition close-modal">Cerrar</button>
            </div>
        </div>
        <div id="movieDetailModal" class="modal-overlay">
            <div class="modal-content">
                <div id="movieDetailContent"></div>
                <button class="w-full p-3 mt-4 bg-gray-600 text-white rounded-md font-bold hover:bg-gray-700 transition close-modal">Cerrar</button>
            </div>
        </div>
        <div id="alertMessage" class="alert-message"></div>
    </div>
    <script>
    const dom = {
        loadMethod: document.getElementById('loadMethod'),
        m3uInput: document.getElementById('m3uInput'),
        xtreamInputs: document.getElementById('xtreamInputs'),
        loadM3uBtn: document.getElementById('loadM3uBtn'),
        loadXtremioBtn: document.getElementById('loadXtremioBtn'),
        showLiveTvBtn: document.getElementById('showLiveTvBtn'),
        showMoviesBtn: document.getElementById('showMoviesBtn'),
        showSeriesBtn: document.getElementById('showSeriesBtn'),
        settingsBtn: document.getElementById('settingsBtn'),
        m3uUrl: document.getElementById('m3uUrl'),
        xtremioServer: document.getElementById('xtremioServer'),
        xtremioUsername: document.getElementById('xtremioUsername'),
        xtremioPassword: document.getElementById('xtremioPassword'),
        mainMenu: document.getElementById('main-menu'),
        loadedContentMenu: document.getElementById('loaded-content-menu'),
        playerView: document.getElementById('player-view'),
        player: document.getElementById('player'),
        videoInfo: document.getElementById('video-info'),
        playerControls: document.getElementById('player-controls'),
        progressBarContainer: document.getElementById('progressBarContainer'),
        progressBar: document.getElementById('progressBar'),
        currentTime: document.getElementById('currentTime'),
        duration: document.getElementById('duration'),
        fullscreenBtn: document.getElementById('fullscreenBtn'),
        playerOverlay: document.getElementById('player-overlay'),
        settingsModal: document.getElementById('settingsModal'),
        clearCredentialsBtn: document.getElementById('clearCredentialsBtn'),
        contentListModal: document.getElementById('contentListModal'),
        searchBar: document.getElementById('searchBar'),
        listItemsContainer: document.getElementById('listItemsContainer'),
        seriesDetailModal: document.getElementById('seriesDetailModal'),
        seriesDetailContent: document.getElementById('seriesDetailContent'),
        movieDetailModal: document.getElementById('movieDetailModal'),
        movieDetailContent: document.getElementById('movieDetailContent'),
        m3uProgress: document.getElementById('m3uProgress'),
        m3uProgressBarFill: document.getElementById('m3uProgressBarFill'),
        m3uProgressText: document.getElementById('m3uProgressText'),
        xtremioProgress: document.getElementById('xtremioProgress'),
        xtremioProgressBarFill: document.getElementById('xtremioProgressBarFill'),
        xtremioProgressText: document.getElementById('xtremioProgressText'),
        alertMessage: document.getElementById('alertMessage')
    };

    let hls = null;
    let movies = [];
    let series = [];
    let liveChannels = [];
    let currentContent = [];

    const saveCredentials = (type, creds) => { localStorage.setItem(`iptv-${type}-creds`, JSON.stringify(creds)); };
    const getCredentials = (type) => { try { return JSON.parse(localStorage.getItem(`iptv-${type}-creds`)); } catch (e) { return null; } };
    const clearCredentials = () => { localStorage.clear(); showMessage('Éxito', 'Credenciales borradas.'); window.location.reload(); };
    const showMessage = (title, message) => { dom.alertMessage.textContent = `${title}: ${message}`; dom.alertMessage.classList.add('show'); setTimeout(() => dom.alertMessage.classList.remove('show'), 5000); };
    const formatTime = (seconds) => { const h = Math.floor(seconds / 3600); const m = Math.floor((seconds % 3600) / 60); const s = Math.floor(seconds % 60); return [h, m, s].map(v => v < 10 ? '0' + v : v).filter((v, i) => v !== '00' || i > 0).join(':'); };
    const createListItem = (item, type) => {
        const itemEl = document.createElement('div');
        itemEl.classList.add('list-item', 'p-2', 'flex', 'items-center', 'space-x-4', 'rounded-lg', 'cursor-pointer');
        itemEl.dataset.url = item.url;
        itemEl.dataset.title = item.name;
        if (type === 'movies' || type === 'series') itemEl.dataset.itemId = item.stream_id || item.series_id;
        itemEl.innerHTML = `
            <img src="${item.logo || item.stream_icon || item.cover || 'https://via.placeholder.com/150'}" alt="${item.name}" class="w-12 h-12 rounded object-cover">
            <div class="info flex-1 overflow-hidden">
                <span class="font-semibold text-white truncate">${item.name}</span>
                <span class="text-sm text-gray-400 truncate">${item.group || item.category_name || item.info.plot || 'N/A'}</span>
            </div>
        `;
        return itemEl;
    };

    const showContentListModal = (contentType) => {
        dom.searchBar.value = '';
        dom.listItemsContainer.innerHTML = '';
        dom.contentListModal.classList.add('show');
        if (contentType === 'live') {
            currentContent = liveChannels;
            renderList(liveChannels);
            dom.searchBar.placeholder = 'Buscar canales...';
        } else if (contentType === 'movies') {
            currentContent = movies;
            renderList(movies);
            dom.searchBar.placeholder = 'Buscar películas...';
        } else if (contentType === 'series') {
            currentContent = series;
            renderList(series);
            dom.searchBar.placeholder = 'Buscar series...';
        }
    };
    const renderList = (data) => {
        dom.listItemsContainer.innerHTML = '';
        data.forEach(item => {
            const itemEl = createListItem(item, dom.loadMethod.value === 'xtream' ? (item.stream_id ? 'movies' : 'series') : 'm3u');
            dom.listItemsContainer.appendChild(itemEl);
        });
    };
    const handleSearch = (e) => {
        const query = e.target.value.toLowerCase();
        const filteredContent = currentContent.filter(item =>
            item.name.toLowerCase().includes(query) ||
            (item.group && item.group.toLowerCase().includes(query))
        );
        renderList(filteredContent);
    };

    const toggleModal = (modalId, show) => {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.toggle('show', show);
        }
    };

    const showXtremioSeriesDetail = async (seriesId) => {
        try {
            const creds = getCredentials('xtremio');
            const seriesInfo = series.find(s => s.series_id == seriesId);
            const seriesEpisodesRes = await (await fetch(`proxy.php?url=${encodeURIComponent(`${creds.server}/player_api.php?username=${creds.username}&password=${creds.password}&action=get_series_info&series_id=${seriesId}`)}`)).json();
            const seasons = seriesEpisodesRes.episodes;
            
            let html = `
                <div class="flex items-center mb-4">
                    <img src="${seriesInfo.cover || 'https://via.placeholder.com/300'}" alt="${seriesInfo.name}" class="w-24 h-24 rounded object-cover mr-4">
                    <h2 class="text-xl font-bold">${seriesInfo.name}</h2>
                </div>
                <p class="text-sm text-gray-400 mb-4">${seriesInfo.plot || 'Sinopsis no disponible.'}</p>
                <div id="seasonTabsContainer" class="flex overflow-x-auto whitespace-nowrap mb-4">
                    ${Object.keys(seasons).map((season, index) => `<button class="tab-button p-2 text-sm mr-2 rounded ${index === 0 ? 'active' : ''}" data-season="${season}">Temporada ${season}</button>`).join('')}
                </div>
                <div class="episode-list-container">
                    ${Object.keys(seasons).map((season, index) => `
                        <div id="season-${season}-episodes" class="episode-list ${index === 0 ? '' : 'hidden'}">
                            ${seasons[season].map(ep => `
                                <div class="list-item p-2 flex items-center space-x-4 rounded-lg cursor-pointer" data-url="${ep.url}" data-title="${ep.title}">
                                    <span class="font-semibold text-white">${ep.episode_num}. ${ep.title}</span>
                                </div>
                            `).join('')}
                        </div>
                    `).join('')}
                </div>
            `;
            dom.seriesDetailContent.innerHTML = html;
            toggleModal('seriesDetailModal', true);
        } catch (e) {
            showMessage('Error', `Fallo al obtener detalles de la serie: ${e.message}`);
        }
    };

    async function loadM3uList() {
        const url = dom.m3uUrl.value.trim();
        const progress = { container: dom.m3uProgress, bar: dom.m3uProgressBarFill, text: dom.m3uProgressText };
        if (!url) { showMessage('Error', 'Por favor, introduce una URL.'); return; }
        progress.container.classList.remove('hidden');
        progress.bar.style.width = '0%';
        progress.text.textContent = 'Cargando lista...';
        try {
            const res = await fetch(`proxy.php?url=${encodeURIComponent(url)}`);
            if (!res.ok) throw new Error('Network response was not ok.');
            const text = await res.text();
            
            const lines = text.split('\n');
            const channels = [];
            let currentChannel = {};

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line.startsWith('#EXTINF')) {
                    const tvgId = line.match(/tvg-id="([^"]*)"/);
                    const tvgName = line.match(/tvg-name="([^"]*)"/);
                    const tvgLogo = line.match(/tvg-logo="([^"]*)"/);
                    const groupTitle = line.match(/group-title="([^"]*)"/);
                    const name = line.split(',').pop();

                    currentChannel = {
                        name: name,
                        id: tvgId ? tvgId[1] : '',
                        logo: tvgLogo ? tvgLogo[1] : '',
                        group: groupTitle ? groupTitle[1] : 'General'
                    };
                } else if (line.startsWith('http')) {
                    currentChannel.url = line;
                    channels.push(currentChannel);
                    currentChannel = {};
                }
            }
            liveChannels = channels;
            movies = [];
            series = [];
            saveCredentials('m3u', { url: url });
            progress.bar.style.width = '100%';
            progress.text.textContent = '¡Lista cargada!';
            dom.mainMenu.classList.add('hidden');
            dom.loadedContentMenu.classList.remove('hidden');
            setTimeout(() => toggleModal('settingsModal', false), 500);
            showContentListModal('live');
        } catch (e) {
            progress.bar.style.width = '100%';
            progress.bar.style.backgroundColor = 'red';
            progress.text.textContent = 'Error al cargar.';
            showMessage('Error', `Fallo al cargar M3U. ${e.message}`);
        }
    }

    async function loadXtremioData(isAutoLoad = false) {
        const creds = { server: dom.xtremioServer.value.trim(), username: dom.xtremioUsername.value.trim(), password: dom.xtremioPassword.value.trim() };
        const progress = { container: dom.xtremioProgress, bar: dom.xtremioProgressBarFill, text: dom.xtremioProgressText };
        if (!creds.server || !creds.username || !creds.password) { showMessage('Error', 'Todos los campos son obligatorios.'); return; }
        if (!isAutoLoad) progress.container.classList.remove('hidden');
        const updateProgress = (p, t) => { progress.bar.style.width = `${p}%`; progress.text.textContent = t; };
        try {
            const baseUrl = `${creds.server}/player_api.php?username=${creds.username}&password=${creds.password}`;
            updateProgress(10, 'Cargando TV...');
            
            const liveStreamsRes = await (await fetch(`proxy.php?url=${encodeURIComponent(`${baseUrl}&action=get_live_streams`)}`)).json();
            const liveCategoriesRes = await (await fetch(`proxy.php?url=${encodeURIComponent(`${baseUrl}&action=get_live_categories`)}`)).json();
            const categoryMap = liveCategoriesRes.reduce((map, cat) => { map[cat.category_id] = cat.category_name; return map; }, {});
            liveChannels = liveStreamsRes.map(c => ({ name: c.name, logo: c.stream_icon, group: categoryMap[c.category_id] || 'General', url: `${creds.server}/live/${creds.username}/${creds.password}/${c.stream_id}.ts` }));

            updateProgress(40, 'Cargando Películas...');
            const moviesRes = await (await fetch(`proxy.php?url=${encodeURIComponent(`${baseUrl}&action=get_vod_streams`)}`)).json();
            movies = moviesRes.map(m => ({ ...m, url: `${creds.server}/movie/${creds.username}/${creds.password}/${m.stream_id}.${m.container_extension}` }));
            
            updateProgress(70, 'Cargando Series...');
            const seriesRes = await (await fetch(`proxy.php?url=${encodeURIComponent(`${baseUrl}&action=get_series`)}`)).json();
            series = seriesRes.map(s => ({ ...s, url: `${creds.server}/series/${creds.username}/${creds.password}/${s.series_id}.${s.container_extension}` }));
            
            updateProgress(100, '¡Completo!');
            saveCredentials('xtremio', creds);
            setTimeout(() => { if (!isAutoLoad) dom.settingsModal.classList.remove('show'); dom.mainMenu.classList.add('hidden'); dom.loadedContentMenu.classList.remove('hidden'); showContentListModal('live'); }, 500);
        } catch (e) {
            updateProgress(100, 'Error.'); progress.bar.style.backgroundColor = 'red'; showMessage('Error', `Fallo al conectar con Xtream. ${e.message}`);
        }
    }
    
    function playStream(url, title = 'Reproduciendo...') {
        dom.playerView.classList.remove('hidden');
        dom.videoInfo.textContent = title;
        if (Hls.isSupported()) {
            if (hls) hls.destroy();
            hls = new Hls();
            hls.loadSource(url);
            hls.attachMedia(dom.player);
            hls.on(Hls.Events.MANIFEST_PARSED, () => dom.player.play());
        } else if (dom.player.canPlayType('application/vnd.apple.mpegurl')) {
            dom.player.src = url;
            dom.player.addEventListener('loadedmetadata', () => dom.player.play());
        } else {
            showMessage('Error', 'Este navegador no soporta el formato de video.');
        }
    }

    const loadAndPlayFromStorage = () => {
        const m3uCreds = getCredentials('m3u');
        const xtremioCreds = getCredentials('xtremio');

        if (m3uCreds) {
            dom.loadMethod.value = 'm3u';
            dom.m3uUrl.value = m3uCreds.url;
            dom.m3uInput.classList.remove('hidden');
            loadM3uList();
        } else if (xtremioCreds) {
            dom.loadMethod.value = 'xtream';
            dom.xtremioServer.value = xtremioCreds.server;
            dom.xtremioUsername.value = xtremioCreds.username;
            dom.xtremioPassword.value = xtremioCreds.password;
            dom.xtreamInputs.classList.remove('hidden');
            loadXtremioData(true);
        }
    };

    dom.loadMethod.addEventListener('change', (e) => {
        dom.m3uInput.classList.add('hidden');
        dom.xtreamInputs.classList.add('hidden');
        if (e.target.value === 'm3u') dom.m3uInput.classList.remove('hidden');
        else if (e.target.value === 'xtream') dom.xtreamInputs.classList.remove('hidden');
    });

    dom.loadM3uBtn.addEventListener('click', loadM3uList);
    dom.loadXtremioBtn.addEventListener('click', loadXtremioData);
    dom.showLiveTvBtn.addEventListener('click', () => showContentListModal('live'));
    dom.showMoviesBtn.addEventListener('click', () => showContentListModal('movies'));
    dom.showSeriesBtn.addEventListener('click', () => showContentListModal('series'));
    dom.settingsBtn.addEventListener('click', () => toggleModal('settingsModal', true));
    dom.clearCredentialsBtn.addEventListener('click', clearCredentials);

    document.addEventListener('click', (e) => {
        const actionTarget = e.target.closest('[data-action]');
        if (actionTarget) {
            switch(actionTarget.dataset.action) {
                case 'show-movie-detail': showXtremioMovieDetail(actionTarget.dataset.movieId); break;
                case 'show-series-detail': showXtremioSeriesDetail(actionTarget.dataset.seriesId); break;
                case 'toggle-collapse': actionTarget.classList.toggle('active'); actionTarget.nextElementSibling.classList.toggle('show'); break;
            }
        }
        const playableItem = e.target.closest('[data-url]');
        if (playableItem) { playStream(playableItem.dataset.url, playableItem.dataset.title); dom.contentListModal.classList.remove('show'); dom.seriesDetailModal.classList.remove('show'); dom.movieDetailModal.classList.remove('show'); }
        
        const seasonTab = e.target.closest('#seasonTabsContainer .tab-button');
        if (seasonTab) {
            const seriesDetailContent = seasonTab.closest('#seriesDetailContent');
            seriesDetailContent.querySelectorAll('#seasonTabsContainer .tab-button').forEach(btn => btn.classList.remove('active'));
            seasonTab.classList.add('active');
            seriesDetailContent.querySelectorAll('.episode-list').forEach(list => list.classList.add('hidden'));
            seriesDetailContent.querySelector(`#season-${seasonTab.dataset.season}-episodes`).classList.remove('hidden');
        }

        const closeModalBtn = e.target.closest('.close-modal');
        if (closeModalBtn) {
            closeModalBtn.closest('.modal-overlay').classList.remove('show');
        }
    });

    dom.searchBar.addEventListener('input', handleSearch);
    document.addEventListener('DOMContentLoaded', loadAndPlayFromStorage);
</script>
</body>
</html>